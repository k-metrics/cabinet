---
title: "rvest"
author: "Sampo Suzuki"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

require(rvest)
require(tidyverse)

site_url <- "https://appmedia.jp/pokemon_go/350150"
xpath_ss <- "/html/body/div[3]/div[1]/div/div/div[3]/div[2]/div/div[2]/table[4]"
xpath_s <- "/html/body/div[3]/div[1]/div/div/div[3]/div[2]/div/div[2]/table[5]"
xpath_ap <- "/html/body/div[3]/div[1]/div/div/div[3]/div[2]/div/div[2]/table[6]"
xpath_a <- "/html/body/div[3]/div[1]/div/div/div[3]/div[2]/div/div[2]/table[7]"
```

## Rank SS
```{r}
(rank_ss <- site_url %>% 
  xml2::read_html() %>% 
  rvest::html_node(xpath = xpath_ss) %>% 
  rvest::html_table() %>% 
  dplyr::mutate(rank = "SS") %>% 
  tidyr::separate(`ポケモン`, into = c("name", "memo", "memo2")) %>% 
  dplyr::mutate(memo2 = dplyr::if_else(name == "アローラ", name, memo2),
                name = dplyr::if_else(name == "アローラ", memo, name),
                name = dplyr::if_else(!is.na(memo2),
                                      paste(name, "（", memo2, "の姿）", sep = ""),
                                      name),
                memo = dplyr::if_else(!is.na(memo2), memo2, memo)) %>% 
  dplyr::select(rank, name, type = `タイプ`, memo, CP = `最大CP`,
                skill = `おすすめわざ`)) %>% 
  DT::datatable()
```

## Rank S
```{r}
(rank_s <- site_url %>% 
  xml2::read_html() %>% 
  rvest::html_node(xpath = xpath_s) %>% 
  rvest::html_table() %>% 
  dplyr::mutate(rank = "S") %>% 
  tidyr::separate(`ポケモン`, into = c("name", "memo", "memo2")) %>% 
  dplyr::mutate(memo2 = dplyr::if_else(name == "アローラ", name, memo2),
                name = dplyr::if_else(name == "アローラ", memo, name),
                name = dplyr::if_else(!is.na(memo2),
                                      paste(name, "（", memo2, "の姿）", sep = ""),
                                      name),
                memo = dplyr::if_else(!is.na(memo2), memo2, memo)) %>% 
  dplyr::select(rank, name, type = `タイプ`, memo, CP = `最大CP`,
                skill = `おすすめわざ`)) %>% 
  DT::datatable()
```

## Rank A+
```{r}
(rank_ap <- site_url %>% 
  xml2::read_html() %>% 
  rvest::html_node(xpath = xpath_ap) %>% 
  rvest::html_table() %>% 
  dplyr::mutate(rank = "A+") %>% 
  tidyr::separate(`ポケモン`, into = c("name", "memo", "memo2")) %>% 
  dplyr::mutate(memo2 = dplyr::if_else(name == "アローラ", name, memo2),
                name = dplyr::if_else(name == "アローラ", memo, name),
                name = dplyr::if_else(!is.na(memo2),
                                      paste(name, "（", memo2, "の姿）", sep = ""),
                                      name),
                memo = dplyr::if_else(!is.na(memo2), memo2, memo)) %>% 
  dplyr::select(rank, name, type = `タイプ`, memo, CP = `最大CP`,
                skill = `おすすめわざ`)) %>% 
  DT::datatable()
```

## Rank A
```{r}
(rank_a <- site_url %>% 
  xml2::read_html() %>% 
  rvest::html_node(xpath = xpath_a) %>% 
  rvest::html_table() %>% 
  dplyr::mutate(rank = "A") %>% 
  tidyr::separate(`ポケモン`, into = c("name", "memo", "memo2")) %>% 
  dplyr::mutate(memo2 = dplyr::if_else(name == "アローラ", name, memo2),
                name = dplyr::if_else(name == "アローラ", memo, name),
                name = dplyr::if_else(!is.na(memo2),
                                      paste(name, "（", memo2, "の姿）", sep = ""),
                                      name),
                memo = dplyr::if_else(!is.na(memo2), memo2, memo)) %>% 
  dplyr::select(rank, name, type = `タイプ`, memo, CP = `最大CP`,
                skill = `おすすめわざ`)) %>% 
  DT::datatable()
```

## Total
```{r}
(rank_all <- rank_ss %>% 
  dplyr::bind_rows(rank_s, rank_ap, rank_a)) %>% 
  DT::datatable()
```

## Cross Table
```{r}
cp_table <- rank_all %>% 
  dplyr::group_by(type) %>% 
  dplyr::summarise(CP = round(max(CP)))

rank_all %>% 
  dplyr::count(rank, type) %>% 
  tidyr::spread(key = rank, value = n) %>% 
  dplyr::left_join(cp_table, .) %>% 
  DT::datatable()
```

## Heat Map
```{r, fig.height=10}
rank_all %>% 
  dplyr::group_by(type, rank) %>% 
  dplyr::summarise(MaxCP = max(CP), MeanCP = round(mean(CP))) %>% 
  ggplot2::ggplot(ggplot2::aes(x = rank, y = type)) + 
    ggplot2::geom_tile(ggplot2::aes(fill = MeanCP)) + 
    ggplot2::geom_text(ggplot2::aes(label = MaxCP), colour = "#FFFFFF") +
    ggplot2::scale_fill_continuous(type = "viridis") +
    ggplot2::labs(subtitle = "白文字の数値は最大CP")
```

```{r}
rank_all %>% 
  dplyr::group_by(type, rank) %>% 
  dplyr::summarise(MaxCP = max(CP), MeanCP = round(mean(CP))) %>% 
  dplyr::mutate(text = dplyr::case_when(MaxCP > MeanCP ~ type, TRUE ~ "")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = MeanCP, y = MaxCP)) + 
    ggplot2::geom_point(ggplot2::aes(colour = rank)) +
    ggrepel::geom_label_repel(ggplot2::aes(label = text, colour = rank))
```

