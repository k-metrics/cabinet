---
title: "カテゴリカルデータを操作する"
output:
  html_document:
    df_print: paged
    code_folding: none
    css: style.css
    highlight: pygment
---

<!-- shared Links -->
```{r index, child="../shared/links.Rmd", include=FALSE}
```

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

require(tidyverse)

# チャンクオプション{r results='asis'}で使うこと
df_summary <- function(df) {
  summarytools::st_options('footnote', NA)
  if (is.data.frame(df)) {
    summarytools::view(summarytools::dfSummary(df, plain.ascii = FALSE,
                                               style = "grid"),
                       method = 'render', omit.headings = FALSE)
  } else {
    return(NULL)
  }
}
```


カテゴリカルデータとは質的データや定性的データとも呼ばれ、名義尺度または順序尺度の離散的なデータのことです。データを層別するような場合には大変便利なデータで、[R][R]では因子型変数として扱うことができます。しかし、因子型変数は他の変数とは異なり水準（`levels`）という属性を持っているために操作が少々厄介な面もあります。本ページでは、そのようなカテゴリカルデータの扱い方を説明します。  
　  

なお、本ページでは`r R.version$version.string`の標準パッケージ以外に以下の追加パッケージを用いています。  
　  

Package   | Version |Description
----------|---------|----------------------------------------------------------
tidyverse | `r packageVersion('tidyverse')` | A sample of categorical variables from the General Social survey
skimr     | `r packageVersion('skimr')` | Compact and Flexible Summaries of Data
summarytools | `r packageVersion('summarytools')` | Tools to Quickly and Neatly Summarize Data

　  

また、本ページでは以下のデータセットを用いています。  
　  

Dataset   | Package  | Version | Description
----------|----------|---------|----------------------------------------------
gss_cat   | forcats  | `r packageVersion('forcats')`| A sample of categorical variables from the General Social survey

　  

```{r, echo=FALSE}
skimr::skim_to_wide(forcats::gss_cat)
```

　  

```{r, results='asis', echo=FALSE}
df_summary(forcats::gss_cat)
```

　  

# 因子型変数
因子型変数を作成するには、名義尺度は`factor`関数、順序尺度は`ordered`関数を用います。因子型変数が作成される場合、作成に使用したデータから自動的にユニークなデータをソートしたものを抽出して水準（levels）として割り当てます。水準（levels）はデータベースにおけるインデックステーブルのようなものだと考えてください。  
　  

## 水準
名義尺度の因子型変数を作成するには前述のように`factor`関数を利用します。`factor`関数では水準を指定するための`levels`オプションがありデフォルトではアルファニューメリック順で水準が作成されます。例えば、"EDCBA"という5文字を因子型にする場合は、  
　  

```{r}
factor(c("E", "A", "A", "C", "D", "0"))
```

　  
となります。`factor`関数は順序尺度を作成する関数ですので、水準には順序関係はありません。順序尺度として扱いたい場合は前述のように`ordered`関数を使います。  
　  

```{r}
ordered(c("E", "A", "A", "C", "D", "0"))
```

　  
`ordered`関数ではこのように水準はアルファニューメリック順の順序関係が付与されていることが分かります。  
　  

## 因子型変数の扱い
このように因子型変数は作成時にデータを元に自動的に水準が作成されます。ここに水準にないデータを追加しようとした場合、    
　  

```{r}
x <- factor(c("E", "A", "A", "C", "D", "0"))
x[6:7] <- c("F", "E")
x
```

　  
このように水準にないデータは追加することができません。  
　  

# forcatsパッケージ
前述のような処理を行うにのに便利なのが`forcats`パッケージです。`forcats`パッケージは

`forcats`パッケージは水準にないデータを追加する場合や水準を操作する場合など因子型変数を扱うための関数が多数用意された便利なパッケージです。  
　  

## 水準を追加する
[Base R][R]で水準を追加する場合には`levels`関数を用いて以下のように行います。
```{r}
x <- factor(c("E", "A", "A", "C", "D", "0"))
x
levels(x)[6] <- "F"
x
```

　  
このように`levels`関数では、指定した位置に水準を追加するため指定位置を間違えるとデータの値も入れ替わってしまいます。
```{r}
x <- factor(c("E", "A", "A", "C", "D", "0"))
x
levels(x)[5] <- "G"
x
```

　  
`forcats`パッケージを利用すると位置を指定する必要がなく指定間違いよりデータの値が入れ替わってしまうリスクもありません。  
```{r}
x <- factor(c("E", "A", "A", "C", "D", "0"))
x
x <- forcats::fct_expand(x, c("G", "F"))
x
x[6:7] <- c("F", "E")
x
```


## 水準を並べ替える

```{r, error=TRUE}
# 手動で並べ替える
x
forcats::fct_relevel(x, "G", after = 7)

# 出現順に並べ替える
f <- forcats::factor(c("b", "b", "a", "c", "c", "c"))
f
forcats::fct_inorder(f)

# レベルにあってもデータにないとエラーになる
x
forcats::fct_inorder(x)

forcats::fct_inorder(factor(c("E", "A", "A", "C", "D", "0")))

x
as.character(sort(unique(x)))
sort(levels(x))

diff()

x <- ordered(c("E", "A", "A", "C", "D", "0"))
x
x <- forcats::fct_expand(x, c("F", "1"))
x[6:7] <- c("F", "E")
x
```

このように標準の[R][R]ではカテゴリカルデータの扱いが少々厄介ですが`forcats`パッケージを使用することで、このような厄介な処理を簡単にこなせるようになります。  
　  

# カテゴリカルデータを扱う
使用するデータは前述にあるように`forcats`パッケージに包含されている`gss_cat`データセットを用います。`gss_cat`は九つの変数からなるデータセットで、内、六つの変数が`factor`型、すなわちカテゴリカルデータです。データの詳細については`forcats`のヘルプをご覧ください。  
　  

```{r}
forcats::gss_cat %>% 
  skimr::skim_to_wide()
```

## 因子型変数の水準を確認する
因子型変数の水準を確認するには`levels`関数、`unique`関数または`forcats::fct_unique`関数を用います。`levels`関数と`forcats::fct_unique`関数の動作は等価で水準は水準順に表示されます。一方、`unique`関数は水準の出現順に水準を表示します。  
　  
```{r}
forcats::gss_cat$marital %>%
  levels()

forcats::gss_cat$marital %>%
  unique()

forcats::gss_cat$marital %>%
  forcats::fct_unique()
```


# 参考資料
* [公式リファレンス（英語） <i class="fa fa-external-link"></i>](https://forcats.tidyverse.org/reference/index.html){target="_blank" title="tidyverse.org"}  
* [{forcats}パッケージでカテゴリカル変数(factor型データ)をいじってみる <i class="fa fa-external-link"></i>](https://kazutan.github.io/kazutanR/forcats_test.html){target="_blank" title="Kazutan.R"}  
　  

---

<!-- Footer -->
```{r child="../shared/footer.Rmd"}
```