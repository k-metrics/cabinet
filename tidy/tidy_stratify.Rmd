---
title: "層別で計算する"
output: 
  html_document:  
    code_folding: show
    number_section: no
    toc: yes
---

<!-- Common Links -->
```{r index, child="../common/links.Rmd", include=FALSE}
```

```{r setup, message=FALSE, warning=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
require(tidyverse)
```

因子ごとに層別して統計量を計算したい時があります。  
　  

# 標準パッケージを用いる方法
標準パッケージで層別統計量を計算するには**`apply`**関数群の**`tapply`**関数を用います。  
　  

## 平均値を計算する
以下のコードは**`iris`**データパッケージの**`Species`**（品種）因子を用いて、各データの平均値を求める方法です。  
　  

```{r}
iris %>% 
  with(tapply(Sepal.Length, Species, mean, na.rm = TRUE)) %>% 
  broom::tidy()                     # 見やすいようにTidy Data化
```

　  

## 五数要約を計算する
```{r}
iris %>% 
  with(tapply(Sepal.Length, Species, fivenum, na.rm = TRUE)) %>% 
  do.call(rbind, .) %>%   # 五数要約の返り値をリスト形式からマトリクス形式に
  broom::tidy()           # Tidy Data化
```

　  

# 追加パッケージを用いる方法
**`dplyr`**パッケージを用いることでパイプ（ %>% ）処理による計算が可能になります。  
　  

## 平均値を計算する
以下のコードは**`iris`**データパッケージの**`Species`**（品種）因子を用いて、各データの平均値を求める方法です。  
　  

```{r}
iris %>% 
  dplyr::group_by(Species) %>% 
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE)
```

　  

## 五数要約を計算する
**`dplyr::summarise`**関数では「返り値の長さが１」である関数のみしか使えませんので返り値の長さが5つある五数要約（**`quantile`**関数）をそのまま計算することはできません。  
　  

### 方法１
**`quantile`**関数の返り値をリスト化して**`dplyr::summarise`**関数に渡し**`cbind`**関数で展開する。  
　  

```{r}
iris %>% 
  dplyr::group_by(Species) %>% 
  dplyr::summarize(qt = list(quantile(Sepal.Length))) %>%
  cbind(do.call(rbind, .$qt)) %>%
  select(-qt)
```

　  

### 方法２
**`dplyr::do`**を用いてリスト化し**`cbind`**関数で展開する。  
　  

```{r}
iris %>%
  dplyr::group_by(Species) %>% 
  dplyr::do(qt = quantile(.$Sepal.Length)) %>%
  cbind(do.call(rbind, .$qt)) %>%
  dplyr::select(-qt)
```

　  

# 参考資料
* [dplyr でグループごとに複数カラムを追加したい](https://qiita.com/hoxo_m/items/9d2f91008335b03bf082)  

---

<!-- Footer -->
```{r child="../common/footer.Rmd"}
```