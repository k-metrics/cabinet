---
title: "データクレンジング"
output: 
  html_document:  
    code_folding: show
    css: style.css
---

<!-- shared Links -->
```{r index, child="../shared/links.Rmd", include=FALSE}
```

```{r setup, message=FALSE, warning=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
require(Nippon)
require(mice)
require(VIM)
require(imputeMissings)
require(tidyverse)

zen <- "./data/text_zen.csv" %>% 
  readr::read_csv()
han <- "./data/text_han.csv" %>% 
  readr::read_csv()
han_kana <- "./data/text_kana.csv" %>% 
  readr::read_csv()
```

データクレンジングとは[IT用語辞典 <i class="fa fa-external-link"></i>](http://e-words.jp/w/%E3%83%87%E3%83%BC%E3%82%BF%E3%82%AF%E3%83%AC%E3%83%B3%E3%82%B8%E3%83%B3%E3%82%B0.html){target="_blank" title="e-Words"}によると「データベースに保存されているデータの中から、重複や誤記、表記の揺れなどを探し出し、削除や修正、正規化などを行い、データの品質を高めること。」と説明されています。よく見かけるクレンジング対象になるデータ例としては  

* 欠損値
* 全角文字と半角文字の混在
* 空白の有無
* 区切り文字の有無や揺れ
* 前（株）後（株）のような表記揺れ

などがあります。特にデータ入力がフリフォーマットの場合はクレンジングを行わないと使い物にならないデータが多くなる傾向があるようにみえます。  
　  

なお、本ページでは`r R.version$version.string`の標準パッケージ以外に以下の追加パッケージを用いています。  
　  

Package   | Version |Description
----------|---------|----------------------------------------------------------
tidyverse | `r packageVersion('tidyverse')` | Easily Install and Load the ‘Tidyverse’
imputeMissings | `r packageVersion('imputeMissings')` | Impute Missing Values in a Predictive Context
mice      | `r packageVersion('mice')` |Multivariate Imputation by Chained Equations
Nippon    | `r packageVersion('Nippon')` | Japanese Utility Functions and Data
stringi   | `r packageVersion('stringi')` | Character String Processing Facilities
VIM       | `r packageVersion('VIM')` | Visualization and Imputation of Missing Values 

　  

また、本ページでは以下のデータセットを用いています。  
　  

Dataset    | Package  | Version | Description
-----------|----------|---------|----------------------------------------------
airquality | datasets | `r packageVersion('datasets')`| New York Air Quality Measurements
han        | N/A      | N/A     | 半角文字のデータセット（自作）
han_kana   | N/A      | N/A     | 半角カナ文字のデータセット（自作）
zen        | N/A      | N/A     | 全角文字のデータセット（自作）

　  

# 欠損値処理
データには必ずと言っていいほどレコードの一部のデータが取得できていないものが含まれます。取得できていないデータを欠損値と呼びます。Rで欠損値を含んだデータを読み込んだ場合、デフォルト処理では欠損値は`NA`という特殊なデータとして処理されます。

欠損値の扱いはデータや分析目的などにより変わりますが、扱い方は大きく以下のように三つに分類されます。

* 欠損値をそのまま扱う
* 欠損値を削除する
* 欠損値を補完する

　  

## 欠損値を削除する
欠損値を含むレコードは不完全なものとして分析対象外として扱う方法です。欠損値を削除する代表的な方法には下表のような方法があります。  

方法               | 詳細
-------------------|---------------------------------------------------
リストワイズ法　| 欠損値を持つレコード全てを削除します
ペアワイズ法    | 統計量の算出に関わる二変数のいずれかに欠損値があるレコードを削除します

Base Rには`na.omit`関数が用意されていますが、`na.omit`関数は`NA`を含む全てのレコードを削除します。特定の変数にNAが含まれている場合にのみ`NA`を削除したい場合には`tidyr::drop_na`関数を用います。  
　  

### リストワイズ法
リストワイズ法により`tidyr::drop_na`関数は`NA`を含む全てのレコードを削除する場合は以下のように行います。  
　  

```{r}
airquality %>% 
  tidyr::drop_na()
```

　  

### ペアワイズ法
例えば`Solar.R`変数と`Wind`変数を用いて統計量を計算するために両変数とも`NA`であるレコードのみを削除するペアワイズ法の場合には

* 統計量計算時のみ当該レコードを削除する
* データセットからレコードを削除する

の二つの方法が考えられますが基本的には全社の統計量計算時のみ欠損値のあるレコードを削除するアプローチを用いるようです（確認中）。例えば相関係数を計算するには`use`オプションで`"pairwise.complete.obs"`を指定します。  
　  

```{r}
cor(airquality$Solar.R, airquality$Wind, use = "pairwise.complete.obs")
```

　  

同様に分散（`var`）や共分散（`cov`）でも同様のオプション指定が可能です。  
　  
データセットから任意の二変数が共にNAの場合のレコードを削除するには以下のような方法があります。  
　  

```{r}
airquality %>% 
  dplyr::mutate(flag = Solar.R | Ozone) %>% 
  tidyr::drop_na(flag) %>% 
  dplyr::select(-flag)
```

　  

## 欠損値を補完する
データ収集対象の性格などにより欠損値の発生が避けられない場合や取得したデータをなるべく活かしたい場合に欠損値を推定して補完する方法があります。

方法               | 詳細
-------------------|-----------------------------------------------
平均値代入法       | 平均値を用いて欠損値を補完します
回帰代入法         | 欠損値を削除したデータから回帰分析を行いその推定値を用いて欠損値を補完します
確率的回帰代入法   | 回帰代入法で得られた推定値にランダム誤差を加えた値で欠損値を補完します
完全情報最尤推定法 | 欠損パターンに応じた尤度関数で最尤推定を行い推定値を求めます
多重代入法         | 欠損値を代入した複数のデータセットを作成してそこから欠損値を推測します
その他の方法       | その他機械学習を用いた補完方法など

上記以外にも変数の性格から欠損値に特定値（例えばゼロ）を割り当てる方法もよく使われる方法です。  
　  

欠損値の補完や削除方法を`airqularity`データセットを用いて説明します。`airquality`データセットは６つの変数それぞれに「`r colSums(is.na(airquality))`」個の`NA`を含むデータセットです。このデータセットを用いて`NA`の代表的な処理例を示します。  
　  

```{r}
airquality
```

　  

### 単一代入法
平均値や回帰値を用いて欠損値を補完する方法を後述の多重代入法と対比させて単一代入法と呼びます。単一代入法のように欠損値を特定の値に変換する場合は、まず変数の値が`NA`であるか否かを判断する必要があります。これには`is.na`関数を用います。例えば`Ozone`変数の`NA`を`Ozone`変数の平均値に変換する場合は`ifelse`関数と組み合わせて処理を行います。  
　  

```{r}
ozone <- airquality %>% 
  dplyr::summarise(ozone_mean = round(mean(Ozone, na.rm = TRUE), 0))

airquality %>% 
  dplyr::mutate(ozone = ifelse(is.na(Ozone), ozone$ozone_mean, Ozone)) %>% 
  dplyr::select(Ozone, ozone, Solar.R, Wind, Temp, Month, Day)
```

　  

平均値代入法の結果を可視化すると下図のようになります。赤線の部分が欠損値を平均値で補完したものです。このような時系列データには不向きな手法に見えます。  
　  

```{r}
airquality %>% 
  dplyr::mutate(Ozone = ifelse(is.na(Ozone), ozone$ozone_mean, Ozone)) %>% 
  dplyr::bind_cols(airquality) %>% 
  dplyr::select(Ozone, Ozone1) %>% 
  tibble::rowid_to_column("days") %>% 
  ggplot2::ggplot(ggplot2::aes(x = days)) + 
    ggplot2::geom_line(ggplot2::aes(y = Ozone), colour = "red") +
    ggplot2::geom_line(ggplot2::aes(y = Ozone1), colour = "blue")
```

　  

### 多重代入法
多重代入法は確率的代入の考えに基づき欠損値を疑似的に補完したデータ（疑似完全データという）を複数作成し、全ての擬似完全データを分析、それらの分析結果を統合して結論（推定値）を出すという代入、解析、統合の三段階で値を導き出す方法です。一口に多重代入法といっても様々なアルゴリズムが提案されていますが、ここで扱う多重代入法はMICE（連鎖方程式による多変量補定）によるものです。  
と書くと何やら難しそうですが、前出の`mice`パッケージを利用することで計算自体は簡単に行えます。例えば、`airquality`データセットでは`Onone`変数と`Solar.R`変数にある欠損値を多重代入法で補完するには以下を実行するだけで済みます。  
　  

```{r}
(aq_mice <- airquality %>% 
  mice::mice(printFlag = FALSE, seed = 0) %>% 
  mice::complete())
```

　  

補完結果がどのようになっているか確認してみます。下図において赤線の部分が欠損値を補完したものです。平均値代入法（単一代入法）にくらべるとかなり"らしい"感じになっていると思います。  
　  

```{r}
aq_mice %>% 
  dplyr::bind_cols(airquality) %>% 
  dplyr::select(Ozone, Ozone1) %>% 
  tibble::rowid_to_column("days") %>% 
  ggplot2::ggplot(ggplot2::aes(x = days)) + 
    ggplot2::geom_line(ggplot2::aes(y = Ozone), colour = "red") +
    ggplot2::geom_line(ggplot2::aes(y = Ozone1), colour = "blue")
```

　  

#### 注意事項
多重代入法は乱数を用いますので、本ページでは`mice::mice`関数に`seed`オプションを指定して発生する乱数を固定することで再現性を確保しています。また、疑似完全データの数はデフォルトの`m = 5`を使用しています。疑似完全データの数は歴史的にはデフォルト値である`m = 5`程度と言われてきたようですが、最近では計算機の処理速度も上がってきているため`m = 20`くらいが目安と言われているようです。
参考までに`mice::mice`関数が計算した疑似完全データセットの密度分布（赤線）を下図に示します。疑似完全データ数が多い方が青線の元データ（欠損値を含むデータの密度分布）から大きく外れた値を計算していないように見えます。  
　  

```{r}
airquality %>% 
  mice::mice(printFlag = FALSE, seed = 0) %>% 
  densityplot()

airquality %>% 
  mice::mice(m = 20, printFlag = FALSE, seed = 0) %>% 
  densityplot()
```

　  

### 機械学習による補完
Rでは機械学習（ランダムフォレスト）による欠損値の補完を`imputeMissings`パッケージを用いて行うことができます。`imputeMissings::compute`関数を用いて学習データを作成し`imputeMissings::impute`関数で補完する値を求めますが、学習データの用意ができない場合でも以下のように対象データを元に演算を行ってくれます。  
　  

```{r}
airquality %>% 
  imputeMissings::impute(method = "randomForest") %>% 
  dplyr::bind_cols(airquality) %>% 
  dplyr::select(Ozone, Ozone1) %>% 
  tibble::rowid_to_column("days") %>% 
  ggplot2::ggplot(ggplot2::aes(x = days)) + 
    ggplot2::geom_line(ggplot2::aes(y = Ozone), colour = "red") +
    ggplot2::geom_line(ggplot2::aes(y = Ozone1), colour = "blue")
```

　  

<!-- # 加工処理 -->
<!-- 区切り文字を使って複数のデータを一つの変数に入れている場合や省略表記（例えば(株)）で文字列が揺れているような場合には`stringr`パッケージが便利です。   -->
<!-- 　   -->

# 正規表現
データのクレンジングを行う場合、憶えておきたいのが正規表現です。特に空白や区切り文字の揺れをクレンジングしたい場合には便利です。  
　  

## 拡張正規表現
Rにおける拡張正規表現はPOSIX 1003.2標準に基づいています。  
　  

### メタ文字
メタ文字（特殊な意味を持つ文字）を指定する場合はメタ文字の前にバックスラッシュ「`\`」（日本語環境では円記号で表示される場合があります）を配置してください。メタ文字とは「`.`」，「`\`」，「`|`」，「`(`」，「`)`」，「`[`」，「`{`」，「`^`」，「`$`」，「`*`」，「`+`」，「`?`」 の12文字です。  
　  

## 文字クラス
文字クラスとは「`[`」と「`]`」で囲まれた文字のリストで、その内のいずれも文字ともマッチします。文字をハイフン「`-`」で結んだ場合は最初の文字から最後の文字の範囲を指定することになります（ただし、ロケール依存）。  
　  

### 名前付き文字クラス
比較的利用頻度が多いと思われる文字クラスが名前付き文字クラスとして定義されています（ただし、ロケール依存）。  
　  

クラス     | 内容                     | 備考
-----------|--------------------------|----------------------------------------
`[:alnum:]`  | アルファベットと数値     | `[:alpha:]` + `[:digit:]`
`[:alpha:]`  | 大小文字アルファベット   | `[:lower:]` + `[:upper:]`
`[:lower:]`  | 小文字アルファベット     | 
`[:upper:]`  | 大文字アルファベット     | 
`[:digit:]`  | 数字                     | 
`[:blank:]`  | 空白文字、スペースとタブ | ロケールによっては全角文字も含む
`[:cntrl:]`  | 制御文字                 | `000-037`, `177`(`DEL`)
`[:graph:]`  | グラフィカル文字         | `[:alnum:]` + `[:punct:]`
`[:print:]`  | 印字可能な文字           | `[:alnum:]` + `[:punct:]` + `[:space:]`
`[:punct:]`  | パンクチュエーション文字 | 記号（`! " # $ % & ' ( ) * + , - . /`）
`[:space:]`  | 空白                     | `[:blank:]` + 改行、水平タブ、給紙、キャリッジリターン
`[:xdigit:]` | 16進数                   | `0-9`, `A-F`, `a-f`

　  

# 日本語特有の処理
日本語を含むデータを処理する場合正規表現だけでは処理できない場合があります。そのような場合には日本語処理に特化した`Nippon`パッケージが便利です。  
　  
なお、本章で利用しているデータセットは作成した以下の全角文字、半角文字、半角カナ文字の三つのデータセットです。  
　  

```{r}

zen
han
han_kana
```

　  

## 全角半角変換
英数記号の全角と半角が混在している場合には`Nippon::zen2han`関数または`Nippon::han2zen`関数が便利です。ヘルプに記載されているように全角半角の双方向に変換できるのはアルファベット、数字、記号のみです。漢数字は半角に変換できますが、漢字、平仮名、片仮名は半角に変換できません。  
　  

`Nippon::zen2han`関数の返り値は単一ベクトル型になりますのでデータフレームに対して適用したい場合は`dplyr::rowwise`関数を用いて行毎に適用してください。
```{r}
zen %>% 
  dplyr::select('全角大文字', '全角小文字', '全角数字', '全角記号') %>% 
  dplyr::rowwise() %>%
  dplyr::mutate('半角大文字' = Nippon::zen2han(全角大文字),
                '半角小文字' = Nippon::zen2han(全角小文字),
                '半角数字' = Nippon::zen2han(全角数字),
                '半角記号' = Nippon::zen2han(全角記号)) %>% 
  dplyr::select('全角大文字', '半角大文字', '全角小文字', '半角小文字',
                '全角数字', '半角数字', '全角記号', '半角記号')
```

　  

`Nippon::han2zen`関数の返り値の型は`Nippon::zen2han`関数と異なり通常のベクトル型になりますのでデータフレームに対して適用する場合でも`dplyr::rowwise`関数を用いる必要はありません。なお、変換元のデータ形式は文字型である必要がありますので注意してください。  
　  

```{r}
han %>% 
  dplyr::mutate('全角大文字' = Nippon::han2zen(半角大文字),
                '全角小文字' = Nippon::han2zen(半角小文字),
                '全角数字' = Nippon::han2zen(as.character(半角数字)),
                '全角記号' = Nippon::han2zen(半角記号),
                '全角カナ' = Nippon::han2zen(半角カナ)) %>% 
  dplyr::select('半角大文字', '全角大文字', '半角小文字', '全角小文字',
                '半角数字', '全角数字', '半角記号', '全角記号',
                '半角カナ', '全角カナ')
```

　  

## 平仮名片仮名変換
平仮名と片仮名が混在している場合には`Nippon::hira2kana`関数または`Nippon::kana2hira`関数が便利です。  
　  

```{r}
zen %>% 
  dplyr::select('全角かな', '全角カナ') %>% 
  dplyr::mutate('カナ変換' = Nippon::hira2kata(全角かな),
                'かな変換' = Nippon::kata2hira(全角カナ)) %>% 
  dplyr::select('全角かな', 'カナ変換', '全角カナ', 'かな変換')
```

　  

## 漢数字変換
漢数字をアラビア数字に変換するには`Nippon::kansu2arabic`関数を用います。`Nippon::kansu2arabic`関数は単一の文字列ベクトル変数（スカラー変数）に対してのみ有効ですので、データフレーム型に適用する場合には`dplyr::rowwise`関数で行毎に処理を適用させる必要があります。漢数字以外に適用してもエラーになりますので注意してください。  
また、"十"、"百"、"千"のように"一"を省略しても数値として意味をなす場合は正しく変換してくれますが、万"、"億"などのように単位だけでは数値として意味をなしにくい場合は正しく変換してくれませんので必ず頭に漢数字を添えてください。  
　  

```{r, include=FALSE}
old <- options()$scipen   # 指数表示にしないための処理
options(scipen = 4)       # scipenは桁数ではない点に注意
```

```{r}
zen %>% 
  dplyr::select('漢数字', '単位') %>% 
  dplyr::rowwise() %>% 
  dplyr::mutate(Arabic = Nippon::kansu2arabic(漢数字),
                Unit = Nippon::kansu2arabic(単位)) %>% 
  dplyr::select('漢数字', Arabic, '単位', Unit)
```


```{r, include=FALSE}
options(scipen = old)     # 桁数表示を元に戻す
```

　  

## 半角全角変換
日本語を含んだデータを扱う上で厄介なのが半角カナ文字です。前述の`Nippon`パッケージでは残念ながら半角全角変換をサポートしていませんので半角カナ文字を扱う場合は`stringi`パッケージの`stringi::str_trans_nfkc`関数を用います。この関数は`ICU(International Components for Unicode)`ライブラリを利用して変換を行っているようです。濁点半濁点、拗音促音、その他を含む半角カナ文字も正しく変換してくれます。前者が変換前、後者が変換後です。    
　  

```{r}
han_kana
han_kana %>% 
  dplyr::mutate_all(funs(stringi::stri_trans_nfkc))
```

　  

# 参考資料
* [欠損値に対応しよう -多重代入法とその他の代入法- <i class="fa fa-external-link"></i>](http://www.procomu.jp/jspd2016/pdf/yougo_kaisetu04.pdf){target="_blank" title="PDF"}
* [データ解析における欠損値対応フロー <i class="fa fa-external-link"></i>](http://fixxman.hatenablog.com/entry/2015/10/06/045417){target="_blank" title="SE Can't Code"}
* [欠損データ分析 -完全情報最尤推定法と多重代入法- <i class="fa fa-external-link"></i>](http://koumurayama.com/koujapanese/missing_data.pdf){target="_blank" title="PDF"}
* [kaggleで予測モデルを構築してみた (5) - Rで行うMultipleImputation <i class="fa fa-external-link"></i>](http://smrmkt.hatenablog.jp/entry/2013/01/06/164758){target="_blank" title="About connecting the dots."}
* [欠損値の種類と補完とRでのワークフロー <i class="fa fa-external-link"></i>](http://pediatricsurgery.hatenadiary.jp/entry/2016/11/20/233217){target="_blank" title="Note of Pediatric Surgery"}
* [欠損値があるデータの分析 <i class="fa fa-external-link"></i>](http://norimune.net/1811){target="_blank" title="Sunny side up!"}
* [欠測値補完に関する調査研究報告書 内閣府経済社会総合研究所 <i class="fa fa-external-link"></i>](http://www.esri.cao.go.jp/jp/stat/report/report_all_detail.pdf){target="_blank" title="PDF"}
* [Rで実践！欠損データ分析入門【2】 <i class="fa fa-external-link"></i>](https://datahotel.io/archives/6573){target="_blank" title="NHN TECHORUS::テックブログ"}
* [dplyr でグループごとに複数カラムを追加したい](https://qiita.com/hoxo_m/items/9d2f91008335b03bf082)  

---

<!-- Footer -->
```{r child="../shared/footer.Rmd"}
```