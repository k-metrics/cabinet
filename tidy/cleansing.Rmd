---
title: "データクレンジング"
output: 
  html_document:  
    code_folding: show
    css: style.css
---

<!-- shared Links -->
```{r index, child="../shared/links.Rmd", include=FALSE}
```

```{r setup, message=FALSE, warning=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
require(Nippon)
require(mice)
require(VIM)
require(tidyverse)
```

　  

# はじめに
データクレンジングとは[IT用語辞典 <i class="fa fa-external-link"></i>](http://e-words.jp/w/%E3%83%87%E3%83%BC%E3%82%BF%E3%82%AF%E3%83%AC%E3%83%B3%E3%82%B8%E3%83%B3%E3%82%B0.html){target="_blank" title="e-Words"}によると「データベースに保存されているデータの中から、重複や誤記、表記の揺れなどを探し出し、削除や修正、正規化などを行い、データの品質を高めること。」と説明されています。よく見かけるクレンジング対象になるデータ例としては  

* 欠損値
* 全角文字と半角文字の混在
* 空白の有無
* 区切り文字の有無や揺れ
* 前（株）後（株）のような表記揺れ

などがあります。特にデータ入力がフリフォーマットの場合はクレンジングを行わないと使い物にならないデータが多くなる傾向があるようにみえます。  
　  

なお、本ページでは標準パッケージ以外に以下の追加パッケージを用いています。  
　  

Package   | Version |Description
----------|---------|----------------------------------------------------------
tidyverse | `r packageVersion('tidyverse')`| Easily Install and Load the ‘Tidyverse’
Nippon    | `r packageVersion('Nippon')`| Japanese Utility Functions and Data
mice      | `r packageVersion('mice')`|Multivariate Imputation by Chained Equations
VIM       | `r packageVersion('VIM')`| Visualization and Imputation of Missing Values 

　  

また、本ページでは以下のデータセットを用いています。  
　  

Dataset    | Package  | Version | Description
-----------|----------|---------|----------------------------------------------
airquality | datasets | `r packageVersion('datasets')`| New York Air Quality Measurements

また、独自のデータセットとして以下を用いています。  

```{r, echo=FALSE}
zen <- "./data/text_zen.csv" %>% 
  readr::read_csv()
han <- "./data/text_han.csv" %>% 
  readr::read_csv()
```
```{r, echo=FALSE}
DT::datatable(zen)
DT::datatable(han)
```


　  

# 欠損値処理の概要
データには必ずと言っていいほどレコードの一部のデータが取得できていないものが含まれます。取得できていないデータを欠損値と呼びます。Rで欠損値を含んだデータを読み込んだ場合、デフォルト処理では欠損値は`NA`という特殊なデータとして処理されます。

欠損値の扱いはデータや分析目的などにより変わりますが、扱い方は大きく以下のように三つに分類されます。

* 欠損値をそのまま扱う
* 欠損値を削除する
* 欠損値を補完する

　  

## 欠損値を削除する
欠損値を含むレコードは不完全なものとして分析対象外として扱う方法です。欠損値を削除する代表的な方法には下表のような方法があります。  

方法            | 詳細
----------------|---------------------------------------------------
リストワイズ法　| 欠損値を持つレコード全てを削除します
ペアワイズ法    | 統計量の算出に関わる二変数のいずれかに欠損値があるレコードを削除します

欠損値を削除する場合には欠損値を含まないようなレコードを取得することが分析の精度を上げるポイントになります。  
　  

## 分析値を補完する
データ収集対象の性格などにより欠損値の発生が避けられない場合や取得したデータをなるべく活かしたい場合に欠損値を推定する方法があります。

方法               | 詳細
-------------------|-----------------------------------------------
平均値代入法       | 平均値を用いて欠損値を補完します
回帰代入法         | 欠損値を削除したデータから回帰分析を行い、その推定値を用いて欠損値を補完します
確率的回帰代入法   | 回帰代入法で得られた推定値にランダム誤差を加えた値で欠損値を補完します
完全情報最尤推定法 | 欠損パターンに応じた尤度関数で最尤推定を行い推定値を求めます
多重代入法         | 欠損値を代入した複数のデータセットを作成して欠損値を推測します

上記以外にも変数の性格から欠損値に特定値（例えばゼロ）を割り当てる方法もよく使われる方法です。  
　  

## 欠損値のパターンを可視化する
欠損値の処理方法は前述のように様々な方法がありますが、まずは、欠損値の発生パターンを把握することが必要です。`mice::md.pattern`関数は欠損値のパターンを可視化してくれます。`airquaility`データセットの欠損値を可視化すると下図のようになります。  
　  

```{r}
mice::md.pattern(airquality)
```

　  
となり`Ozone`変数の欠損値が最も多く、ついで`Solar.R`の欠損値が多いことが分かります。更に詳細な可視化が必要な場合は`VIM`パッケージを用います。  
　  

```{r}
VIM::marginplot(airquality[, c("Ozone", "Solar.R")])
```

　  

<!-- ```{r} -->
<!-- VIM::aggr(airquality) -->
<!-- ``` -->

# 欠損値の処理方法
欠損値の補完や削除方法を`airqularity`データセットを用いて説明します。`airquality`データセットは６つの変数それぞれに「`r colSums(is.na(airquality))`」個の`NA`を含むデータセットです。このデータセットを用いて`NA`の代表的な処理例を示します。  
　  

```{r}
airquality
```

　  

## 特定の値に変換する
平均値代入法、回帰代入法のように欠損値を特定の値に変換する場合は、まず変数の値が`NA`であるか否かを判断する必要があります。これには`is.na`関数を用います。例えば`Ozone`変数の`NA`を`Ozone`変数の平均値に変換する場合は`ifelse`関数と組み合わせて処理を行います。  
　  

```{r}
ozone <- airquality %>% 
  dplyr::summarise(mean = round(mean(Ozone, na.rm = TRUE), 4),
                   median = round(median(Ozone, na.rm = TRUE)))

airquality %>% 
  dplyr::mutate(ozone = ifelse(is.na(Ozone), ozone$mean, Ozone)) %>% 
  dplyr::select(Ozone, ozone, Solar.R, Wind, Temp, Month, Day)
```

　  

## 欠損値を含むレコードを削除する
NAを含むデータを削除する場合

* NAが含まれているレコード全てを削除する（リストワイズ法）
* 特定の変数にNAが含まれているレコードを削除する（ペアワイズ法）

のどちらかの方法があります。Base Rには`na.omit`関数が用意されていますが、`na.omit`関数は`NA`を含む全てのレコードを削除します。特定の変数にNAが含まれている場合にのみ`NA`を削除したい場合には`tidyr::drop_na`関数を用います。  
　  

### リストワイズ法
リストワイズ法により`tidyr::drop_na`関数は`NA`を含む全てのレコードを削除する場合は以下のように行います。  
　  

```{r}
airquality %>% 
  tidyr::drop_na()
```

　  

### ペアワイズ法
例えば`Solar.R`変数と`Wind`変数を用いて統計量を計算するために両変数とも`NA`であるレコードのみを削除するペアワイズ法の場合には

* 統計量計算時のみ当該レコードを削除する
* データセットからレコードを削除する

の二つの方法が考えられますが基本的には全社の統計量計算時のみ欠損値のあるレコードを削除するアプローチを用いるようです（確認中）。例えば相関係数を計算するには`use`オプションで`"pairwise.complete.obs"`を指定します。  
　  

```{r}
cor(airquality$Solar.R, airquality$Wind, use = "pairwise.complete.obs")
```

　  

同様に分散（`var`）や共分散（`cov`）でも同様のオプション指定が可能です。  
　  
データセットから任意の二変数が共にNAの場合のレコードを削除するには以下のような方法があります。  
　  

```{r}
airquality %>% 
  mutate(flag = Solar.R | Ozone) %>% 
  tidyr::drop_na(flag) %>% 
  dplyr::select(-flag)
```

　  

## 平均値代入法
平均値代入法はその名の通り平均値を用いて欠損値を補完する方法です。「特定の値に変換する」の項で示したように`is.na`関数を用いる方法を用いるのが簡単です。ちなみに平均値代入法のような特定の値（単一の値）で欠損値を補完する方法を後述の多重代入法と対比させて単一代入法と呼ぶこともあります。  
　  

## 完全情報最尤推定法
（調査中）
　  

## 多重代入法
多重代入法は欠損値を疑似的に補完したデータセット（疑似完全データともいう）を複数作成し、統計分析を行う際に作成した全ての疑似完全データを用いて統計分析を行い、分析結果を統合して結論を出す方法です。なお、疑似完全データの作成にはベイズ統計学を利用します。  
と書くと何やら難しそうですが、前出の`mice`パッケージを利用することで計算が可能です。例えば、`airquality`データセットでは`Onone`変数と`Solar.R`変数にある欠損値を多重代入法で補完するには以下を実行するだけで済みます。  
　  

```{r, include=FALSE}
aq_mice <- airquality %>% 
  mice::mice() %>% 
  mice::complete()
```

```{r, eval=FALSE}
aq_mice <- airquality %>% 
  mice::mice() %>% 
  mice::complete()
```

```{r}
DT::datatable(aq_mice)
```

　  

### 可視化による比較
補完結果がどのようになっているか確認してみます。下図において赤線の部分が欠損値を補完したものです。主観ですが、かなりいい感じになっていると思います。
```{r, echo=FALSE}
# airquality %>% 
#   mice::mice() %>% 
#   mice::complete() %>% 
aq_mice %>% 
  dplyr::bind_cols(airquality) %>% 
  dplyr::select(Ozone, Ozone1, Solar.R, Solar.R1) %>% 
  tibble::rowid_to_column("days") %>% 
  ggplot2::ggplot(ggplot2::aes(x = days)) + 
    ggplot2::geom_line(ggplot2::aes(y = Ozone), colour = "red") +
    ggplot2::geom_line(ggplot2::aes(y = Ozone1), colour = "blue")
```

　  

下図の平均値代入法（単一代入法）と比べての`airquality`データセットでは上図の多重代入法を用いた方がより適切な補完が行われていると言えます。  
　  

```{r, echo=FALSE}
ozone <- airquality %>% 
  dplyr::summarise(ozone_mean = round(mean(Ozone, na.rm = TRUE)),
                   solar_mean = round(median(Solar.R, na.rm = TRUE)))

airquality %>% 
  dplyr::mutate(Ozone = ifelse(is.na(Ozone), ozone$ozone_mean, Ozone),
                Solar.R = ifelse(is.na(Solar.R), ozone$solar_mean, Solar.R)) %>% 
  dplyr::bind_cols(airquality) %>% 
  dplyr::select(Ozone, Ozone1, Solar.R, Solar.R1) %>% 
  tibble::rowid_to_column("days") %>% 
  ggplot2::ggplot(ggplot2::aes(x = days)) + 
    ggplot2::geom_line(ggplot2::aes(y = Ozone), colour = "red") +
    ggplot2::geom_line(ggplot2::aes(y = Ozone1), colour = "blue")
```

　  

<!-- # 分割・結合・置換 -->
<!-- 氏名や日付のようなデータが一つの変数として扱われている場合や複数の変数として扱われているような場合があります。このような場合、その後の処理によってはデータを分割したり結合したりしておきたい場合があります。 -->



<!-- ## ベクトル変数の場合 -->
<!-- ## 文字列の場合 -->

<!-- ## 分割 -->
<!-- ```{r} -->
<!-- # tidyr::separate() -->
<!-- ``` -->

<!-- ## 結合 -->

<!-- ```{r} -->
<!-- airquality %>%  -->
<!--   tidyr::unite("Date", Month, Day, sep = "/") -->
<!-- ``` -->


<!-- 　   -->

# 正規表現
データのクレンジングを行う場合、憶えておきたいのが正規表現です。特に空白や区切り文字の揺れをクレンジングしたい場合には便利です。  
　  

## 拡張正規表現
Rにおける拡張正規表現はPOSIX 1003.2標準に基づいています。  
　  

### メタ文字
メタ文字（特殊な意味を持つ文字）を指定する場合はメタ文字の前にバックスラッシュ「`\`」（日本語環境では円記号で表示される場合があります）を配置してください。メタ文字とは「`.`」，「`\`」，「`|`」，「`(`」，「`)`」，「`[`」，「`{`」，「`^`」，「`$`」，「`*`」，「`+`」，「`?`」 の12文字です。  
　  

## 文字クラス
文字クラスとは「`[`」と「`]`」で囲まれた文字のリストで、その内のいずれも文字ともマッチします。文字をハイフン「`-`」で結んだ場合は最初の文字から最後の文字の範囲を指定することになります（ただし、ロケール依存）。  
　  

### 名前付き文字クラス
比較的利用頻度が多いと思われる文字クラスが名前付き文字クラスとして定義されています（ただし、ロケール依存）。  
　  

クラス     | 内容                     | 備考
-----------|--------------------------|----------------------------------------
`[:alnum:]`  | アルファベットと数値     | `[:alpha:]` + `[:digit:]`
`[:alpha:]`  | 大小文字アルファベット   | `[:lower:]` + `[:upper:]`
`[:lower:]`  | 小文字アルファベット     | 
`[:upper:]`  | 大文字アルファベット     | 
`[:digit:]`  | 数字                     | 
`[:blank:]`  | 空白文字、スペースとタブ | ロケールによっては全角文字も含む
`[:cntrl:]`  | 制御文字                 | `000-037`, `177`(`DEL`)
`[:graph:]`  | グラフィカル文字         | `[:alnum:]` + `[:punct:]`
`[:print:]`  | 印字可能な文字           | `[:alnum:]` + `[:punct:]` + `[:space:]`
`[:punct:]`  | パンクチュエーション文字 | 記号（`! " # $ % & ' ( ) * + , - . /`）
`[:space:]`  | 空白                     | `[:blank:]` + 改行、水平タブ、給紙、キャリッジリターン
`[:xdigit:]` | 16進数                   | `0-9`, `A-F`, `a-f`

　  

# 日本語特有の処理
日本語を含むデータを処理する場合正規表現だけでは処理できない場合があります。そのような場合には日本語処理に特化した`Nippon`パッケージが便利です。  
　  

## 全角半角変換
英数記号の全角と半角が混在している場合には`Nippon::zen2han`関数または`Nippon::han2zen`関数が便利です。ヘルプに記載されているように全角半角の双方向に変換できるのはアルファベット、数字、記号のみです。漢数字は半角に変換できますが、漢字、平仮名、片仮名は半角に変換できません。  
　  

`Nippon::zen2han`関数の返り値は単一ベクトル型になりますのでデータフレームに対して適用したい場合は`dplyr::rowwise`関数を用いて行毎に適用してください。
```{r}
zen %>% 
  dplyr::select('全角大文字', '全角小文字', '全角数字', '全角記号') %>% 
  dplyr::rowwise() %>%
  dplyr::mutate('半角大文字' = Nippon::zen2han(全角大文字),
                '半角小文字' = Nippon::zen2han(全角小文字),
                '半角数字' = Nippon::zen2han(全角数字),
                '半角記号' = Nippon::zen2han(全角記号)) %>% 
  dplyr::select('全角大文字', '半角大文字', '全角小文字', '半角小文字',
                '全角数字', '半角数字', '全角記号', '半角記号')
```

　  

`Nippon::han2zen`関数の返り値の型は`Nippon::zen2han`関数と異なり通常のベクトル型になりますのでデータフレームに対して適用する場合でも`dplyr::rowwise`関数を用いる必要はありません。なお、変換元のデータ形式は文字型である必要がありますので注意してください。  
　  

```{r}
han %>% 
  dplyr::mutate('全角大文字' = Nippon::han2zen(半角大文字),
                '全角小文字' = Nippon::han2zen(半角小文字),
                '全角数字' = Nippon::han2zen(as.character(半角数字)),
                '全角記号' = Nippon::han2zen(半角記号),
                '全角カナ' = Nippon::han2zen(半角カナ)) %>% 
  dplyr::select('半角大文字', '全角大文字', '半角小文字', '全角小文字',
                '半角数字', '全角数字', '半角記号', '全角記号',
                '半角カナ', '全角カナ')
```

　  

## 平仮名片仮名変換
平仮名と片仮名が混在している場合には`Nippon::hira2kana`関数または`Nippon::kana2hira`関数が便利です。  
　  

```{r}
zen %>% 
  dplyr::select('全角かな', '全角カナ') %>% 
  dplyr::mutate('カナ変換' = Nippon::hira2kata(全角かな),
                'かな変換' = Nippon::kata2hira(全角カナ)) %>% 
  dplyr::select('全角かな', 'カナ変換', '全角カナ', 'かな変換')
```

　  

## ローマ字変換
```{r}
Nippon::kana2roma(zen$全角かな)
Nippon::kana2roma(zen$全角カナ)
```

 
## 漢数字変換
漢数字をアラビア数字に変換するには`Nippon::kansu2arabic`関数を用います。`Nippon::kansu2arabic`関数は単一の文字列ベクトル変数（スカラー変数）に対してのみ有効ですので、データフレーム型に適用する場合には`dplyr::rowwise`関数で行毎に処理を適用させる必要があります。漢数字以外に適用してもエラーになりますので注意してください。  
また、"十"、"百"、"千"のように"一"を省略しても数値として意味をなす場合は正しく変換してくれますが、万"、"億"などのように単位だけでは数値として意味をなしにくい場合は正しく変換してくれませんので必ず頭に漢数字を添えてください。  
　  

```{r, include=FALSE}
old <- options()$scipen   # 指数表示にしないための処理
options(scipen = 4)       # scipenは桁数ではない点に注意
```

```{r}
zen %>% 
  dplyr::select('漢数字', '単位') %>% 
  dplyr::rowwise() %>% 
  dplyr::mutate(Arabic = Nippon::kansu2arabic(漢数字),
                Unit = Nippon::kansu2arabic(単位)) %>% 
  dplyr::select('漢数字', Arabic, '単位', Unit)
```


```{r, include=FALSE}
options(scipen = old)     # 桁数表示を元に戻す
```

　  

# 参考資料
* [欠損値に対応しよう -多重代入法とその他の代入法- <i class="fa fa-external-link"></i>](http://www.procomu.jp/jspd2016/pdf/yougo_kaisetu04.pdf){target="_blank" title="PDF"}
* [データ解析における欠損値対応フロー <i class="fa fa-external-link"></i>](http://fixxman.hatenablog.com/entry/2015/10/06/045417){target="_blank" title="SE Can't Code"}
* [欠損データ分析 -完全情報最尤推定法と多重代入法- <i class="fa fa-external-link"></i>](http://koumurayama.com/koujapanese/missing_data.pdf){target="_blank" title="PDF"}
* [kaggleで予測モデルを構築してみた (5) - Rで行うMultipleImputation <i class="fa fa-external-link"></i>](http://smrmkt.hatenablog.jp/entry/2013/01/06/164758){target="_blank" title="About connecting the dots."}
* [欠損値の種類と補完とRでのワークフロー <i class="fa fa-external-link"></i>](http://pediatricsurgery.hatenadiary.jp/entry/2016/11/20/233217){target="_blank" title="Note of Pediatric Surgery"}
* [dplyr でグループごとに複数カラムを追加したい](https://qiita.com/hoxo_m/items/9d2f91008335b03bf082)  

---

<!-- Footer -->
```{r child="../shared/footer.Rmd"}
```