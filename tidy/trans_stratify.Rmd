---
title: "層別で計算する"
output: 
  html_document:  
    code_folding: show
    number_section: no
    toc: yes
---

<!-- Common Links -->
```{r index, child="../common/links.Rmd", include=FALSE}
```

```{r setup, message=FALSE, warning=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
require(tidyverse)
```

因子ごとに層別して統計量を計算したい時があります。  
　  

# 標準パッケージを用いる方法
標準パッケージで層別統計量を計算するには**`apply`**関数群の**`tapply`**関数を用います。統計用の計算結果が一つの値（長さ1になる）の場合と複数の値（長さ2以上）になる場合では、層別の統計量算出後に型変換する場合は処理方法が異なりますので、その点についても記載しておきます。  
　  

## 平均値を計算する
[R][R]に標準で組み込まれている**`iris`**データセットを用いて**`Sepal.Length`**（萼片の長さ）の平均値を**`Species`**（品種）毎に計算してみます。
```{r}
with(iris, tapply(Sepal.Length, Species, mean, na.rm = TRUE))
```
　  
**`tapply`**関数の返り値はアレイ型ですが、**`mean`**関数の返り値が長さ1のベクトル型ですので、その後に型の変換処理を行いたい場合は以下のように比較的簡単にできます。  
　  

### マトリクス型に変換する
```{r}
as.matrix(with(iris,
               tapply(Sepal.Length, Species, mean, na.rm = TRUE)))
```
　  

### データフレーム型に変換する
```{r}
as.data.frame(
  as.matrix(with(iris,
                 tapply(Sepal.Length, Species, mean, na.rm = TRUE))))
```

　  

## 五数要約を計算する
同様に**`fivenum`**関数で五数要約（最小値、第1四分位数、中央値、第3四分位数、最大値）を計算してみましょう。  
```{r}
with(iris, tapply(Sepal.Length, Species, fivenum, na.rm = TRUE))
```
　  
**`fivenum`**関数のように返り値の長さが1より大きいベクトルの場合は、平均値を計算した時とは異なり型を変換するにはひと手間必要です。  
　  

### マトリクス型に変換する
**`tapply`**関数の返り値は複数の値を持つアレイ型ですので**`do.call`**関数を用いて行方向に結合する必要があります。  
```{r}
do.call(rbind, 
        with(iris, tapply(Sepal.Length, Species, fivenum, na.rm = TRUE)))
```

### データフレーム型に変換する
データフレーム型に変換する場合は、一度、マトリクス形式に変換してから再変換する必要があります。  
```{r}
as.data.frame(do.call(rbind, 
                      with(iris, tapply(Sepal.Length, Species,
                                        fivenum, na.rm = TRUE))))
```

　  

# 追加パッケージを用いる方法
**`dplyr`**パッケージを用いることでパイプ（ %>% ）処理による分かりやすい処理が可能になります。  
　  

## 平均値を計算する
[標準パッケージを用いる方法](#base)と同様の処理を**`dplyr`**パッケージを用いて処理すると以下のように全ての数値変数に対して一度に処理できるようになります。
```{r}
require(tidyverse)

iris %>% 
  dplyr::group_by(Species) %>% 
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE)
```

　  

## 五数要約を計算する
**`dplyr::summarise`**関数では「返り値の長さが1」である関数のみしか使えませんので、返り値の長さが5つある五数要約（**`quantile`**関数）を平均値の計算の時のように計算することはできません。なお、**`mean`**関数のように全ての数値変数に対して一度に処理することはできませんので注意してください。  
　  

### 方法１
**`quantile`**関数の返り値をリスト型にしてから**`dplyr::summarise`**関数に渡し**`cbind`**関数で列方向に展開します。  
```{r}
require(tidyverse)

iris %>% 
  dplyr::group_by(Species) %>% 
  dplyr::summarize(qt = list(quantile(Sepal.Length, na.rm = TRUE))) %>%
  cbind(do.call(rbind, .$qt)) %>%
  dplyr::select(-qt)
```

　  

### 方法２
**`dplyr::do`**を用いてリスト型の返り値を**`cbind`**関数で展開します。より**`dplyr`**的な処理です。  
```{r}
require(tidyverse)

iris %>%
  dplyr::group_by(Species) %>% 
  dplyr::do(qt = quantile(.$Sepal.Length, na.rm = TRUE)) %>%
  cbind(do.call(rbind, .$qt)) %>%
  dplyr::select(-qt)
```

　  

# 参考資料
* [dplyr でグループごとに複数カラムを追加したい](https://qiita.com/hoxo_m/items/9d2f91008335b03bf082)  

---

<!-- Footer -->
```{r child="../common/footer.Rmd"}
```