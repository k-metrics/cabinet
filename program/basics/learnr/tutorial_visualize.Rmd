---
title: "ggplot2のすゝめ"
output:
  learnr::tutorial:
    highlight: textmate
    md_extensions: -ascii_identifiers
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
# 共通chunkオプションの指定
knitr::opts_chunk$set(warning = FALSE, echo = TRUE)

require(learnr)
require(tidyverse)
require(gridExtra)
require(DT)
require(knitr)
tidyverse::tidyverse_conflicts()
```

<!-- 最初に変数fileに使用するデータをフルパスで指定して下さい -->
```{r common, include=FALSE}
if (Sys.getenv("OS") == "Windows_NT") {
  file_path <- "C:\\Users\\suzuki\\Dropbox\\RStudio\\cabinet\\program\\basics\\data\\odc.csv"
} else {
  file_path <- "/home/sampo/Dropbox/RStudio/cabinet/program/basics/data/odc.csv"
}
odc <- read_csv(file_path, locale = locale(encoding = "CP932"), progress = FALSE)
```

## About Tutorial
「dplyrのすゝめ」ではデータの扱い方を学びましたが、本チュートリアルではODC分析における可視化を例にして[R][R]で可視化処理するために必要な基礎知識を学びます。なお、本チュートリアルを実行するための必要な環境については[こちら](https://k-metrics.github.io/cabinet/program/basics/#チュートリアル資料について)で確認して下さい。

### 対象データ
ODC
前述のように具体的な事例としてBTSのデータを用います。BTSのデータは[Redmine.JP](http://redmine.jp/glossary/i/issue/)で公開されている[サンプルDB](http://www.redmine.org/projects/redmine/issues)を用いますので、予めCSV形式でエクスポートしておいて下さい。


#### 事前設定
データファイルのフルパスを本ファイルの`common`チャンクにある`file_path`に設定しておいて下さい。

### 整然データ
整然データ（Tidy Data）とはJournal of Statistical Software Vol.59(2014)に掲載されたHadley Wickhamの論文[Tidy Data](https://www.jstatsoft.org/article/view/v059i10)において提唱されたデータ分析に有用な概念です。簡潔に日本語で整理された情報は[整然データとは何か](http://id.fnshr.info/2017/01/09/tidy-data-intro/)や[整然データってなに？](https://speakerdeck.com/fnshr/zheng-ran-detatutenani)で公開されていますので、まずは、こちらで整然データ（Tidy Data）の概念を把握しておいて下さい。

## Tidy

### データの確認
```{r, eval=FALSE}
odc %>% 
  DT::datatable()
```

```{r, eval=FALSE}
odc %>% 
  dplyr::select(Status = 'ステータス', Result = '解決状況', Date = '発生日',
                Rank = '障害ランク', Step = '欠陥検出工程',
                Trigger = '発生トリガー', Type = '欠陥実装タイプ') %>% 
  dplyr::count(Date, Trigger) %>% 
  ggplot2::ggplot(aes(x = Date, y = n)) + 
    ggplot2::geom_bar(aes(fill = Trigger), stat = "identity")
```

```{r, eval=FALSE}
odc %>% 
  dplyr::select(Status = 'ステータス', Result = '解決状況', Date = '発生日',
                Rank = '障害ランク', Step = '欠陥検出工程',
                Trigger = '発生トリガー', Type = '欠陥実装タイプ') %>% 
  dplyr::count(Date, Trigger) %>% 
  tidyr::spread(key = Trigger, value = n) %>% 
  dplyr::mutate_if(is.numeric, funs(replace(., is.na(.), 0))) %>% 
  dplyr::mutate_if(is.numeric, cumsum) %>%
  tidyr::gather(key = Trigger, value = n, -Date) %>% 
  ggplot2::ggplot(aes(x = Date, y = n)) + 
    ggplot2::geom_bar(aes(fill = Trigger), stat = "identity")
```

```{r, eval=FALSE}
odc %>% 
  dplyr::select(Status = 'ステータス', Result = '解決状況', Date = '発生日',
                Rank = '障害ランク', Step = '欠陥検出工程',
                Trigger = '発生トリガー', Type = '欠陥実装タイプ') %>% 
  dplyr::filter(Type != "（障害ではない）") %>% 
  dplyr::count(Date, Trigger) %>% 
  tidyr::spread(key = Trigger, value = n) %>% 
  dplyr::mutate_if(is.numeric, funs(replace(., is.na(.), 0))) %>% 
  dplyr::mutate_if(is.numeric, cumsum) %>%
  tidyr::gather(key = Trigger, value = n, -Date) %>% 
  ggplot2::ggplot(aes(x = Date, y = n)) + 
    ggplot2::geom_bar(aes(fill = Trigger), stat = "identity")
```

```{r, eval=FALSE}
odc %>% 
  dplyr::select(Status = 'ステータス', Result = '解決状況', Date = '発生日',
                Rank = '障害ランク', Step = '欠陥検出工程',
                Trigger = '発生トリガー', Type = '欠陥実装タイプ') %>% 
  dplyr::filter(Type != "（障害ではない）") %>% 
  dplyr::count(Date, Rank) %>% 
  tidyr::spread(key = Rank, value = n) %>% 
  dplyr::mutate_if(is.numeric, funs(replace(., is.na(.), 0))) %>% 
  dplyr::mutate_if(is.numeric, cumsum) %>%
  tidyr::gather(key = Rank, value = n, -Date) %>% 
  ggplot2::ggplot(aes(x = Date, y = n)) + 
    ggplot2::geom_bar(aes(fill = Rank), stat = "identity")
```

```{r, eval=FALSE}
odc %>% 
  dplyr::select(Status = 'ステータス', Result = '解決状況', Date = '発生日',
                Rank = '障害ランク', Step = '欠陥検出工程',
                Trigger = '発生トリガー', Type = '欠陥実装タイプ') %>% 
  dplyr::filter(Type != "（障害ではない）") %>% 
  dplyr::count(Date, Step) %>% 
  tidyr::spread(key = Step, value = n) %>% 
  dplyr::mutate_if(is.numeric, funs(replace(., is.na(.), 0))) %>% 
  dplyr::mutate_if(is.numeric, cumsum) %>%
  tidyr::gather(key = Step, value = n, -Date) %>% 
  ggplot2::ggplot(aes(x = Date, y = n)) + 
    ggplot2::geom_bar(aes(fill = Step), stat = "identity")
```


```{r, eval=FALSE}
odc %>% 
  dplyr::select(Status = 'ステータス', Result = '解決状況', Date = '発生日',
                Rank = '障害ランク', Step = '欠陥検出工程',
                Trigger = '発生トリガー', Type = '欠陥実装タイプ') %>% 
  dplyr::filter(Type != "（障害ではない）") %>% 
  dplyr::count(Date, Type) %>% 
  tidyr::spread(key = Type, value = n) %>% 
  dplyr::mutate_if(is.numeric, funs(replace(., is.na(.), 0))) %>% 
  dplyr::mutate_if(is.numeric, cumsum) %>%
  tidyr::gather(key = Type, value = n, -Date) %>% 
  ggplot2::ggplot(aes(x = Date, y = n)) + 
    ggplot2::geom_bar(aes(fill = Type), stat = "identity")
```


## Visualize
度数集計したデータを可視化してみましょう。可視化にはパイプ演算子をそのまま使える`ggplot2`パッケージを用います。`ggplot2`パッケージの基本文法は以下のような形ですが、詳細は別チュートリアルにて
```{r, eval=FALSE}
ggplot(aes(x, y, ...)) +
  geom_*(aes(x, y, ...), ...)
```

### 棒グラフ
まず、日毎のチケット起票数を棒グラフで描いてみましょう。棒グラフを描くには`ggplot2::geom_bar`関数を用います。
```{r geom_bar, exercise=TRUE, exercise.setup="common", exercise.lines=11, message=FALSE}
bugs %>% 
  dplyr::select('#', 'トラッカー', 'ステータス', '作成日') %>% 
  dplyr::rename(ID = '#', Tracker = 'トラッカー', Status = 'ステータス',
                DateTime = '作成日') %>% 
  dplyr::mutate(Date = lubridate::as_date(DateTime)) %>% 
  dplyr::count(Date) %>% 
  dplyr::mutate(Cum = cumsum(n)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = Date)) + 
    ggplot2::geom_bar(aes(y = n), stat = "identity") + 
    ggplot2::ylab("Num of Tickets")
```

### 折れ線グラフ
続いてチケット累計度数を折れ線グラフで描いて見ましょう。折れ線グラフを描くには`ggplot::geom_line`関数を用います。
```{r geom_line, exercise=TRUE, exercise.setup="common", exercise.lines=11, message=FALSE}
bugs %>% 
  dplyr::select('#', 'トラッカー', 'ステータス', '作成日') %>% 
  dplyr::rename(ID = '#', Tracker = 'トラッカー', Status = 'ステータス',
                DateTime = '作成日') %>% 
  dplyr::mutate(Date = lubridate::as_date(DateTime)) %>% 
  dplyr::count(Date) %>% 
  dplyr::mutate(Cum = cumsum(n)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = Date)) + 
    ggplot2::geom_line(aes(y = Cum)) + 
    ggplot2::ylab("Num of Tickets")
```

### 重ね合わせ
前述の棒グラフと折れ線グラフを重ねてみましょう。`ggplot2`パッケージでは基本的に重ねて描きたいグラフは追記していくだけで描くことができます。
```{r ggplot, exercise=TRUE, exercise.setup="common", exercise.lines=12, message=FALSE}
bugs %>% 
  dplyr::select('#', 'トラッカー', 'ステータス', '作成日') %>% 
  dplyr::rename(ID = '#', Tracker = 'トラッカー', Status = 'ステータス',
                DateTime = '作成日') %>% 
  dplyr::mutate(Date = lubridate::as_date(DateTime)) %>% 
  dplyr::count(Date) %>% 
  dplyr::mutate(Cum = cumsum(n)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = Date)) + 
    ggplot2::geom_bar(aes(y = n), stat = "identity", na.rm = TRUE) + 
    ggplot2::geom_line(aes(y = Cum), na.rm = TRUE) + 
    ggplot2::ylab("Num of Tickets")
```

```{r, eval=FALSE, include=FALSE}
bugs %>% 
  dplyr::select('#', 'トラッカー', 'ステータス', '作成日') %>% 
  dplyr::rename(ID = '#', Tracker = 'トラッカー', Status = 'ステータス',
                DateTime = '作成日') %>% 
  dplyr::mutate(Date = lubridate::as_date(DateTime)) %>% 
  dplyr::group_by(Date) %>% 
  dplyr::tally() %>% 
  dplyr::ungroup() %>%            # ungroupはなくても集計できます
  dplyr::mutate(Cum = cumsum(n)) %>% 
  tibble::rowid_to_column() %>% 
    ggplot2::ggplot(ggplot2::aes(x = rowid)) + 
    ggplot2::geom_bar(aes(y = n), stat = "identity", na.rm = TRUE) + 
    ggplot2::geom_line(aes(y = Cum), na.rm = TRUE) + 
    ggplot2::ylab("Num of Tickets")
```



## Transform/Join
グラフを描く際に作成した日毎の度数集計をクロス集計表と結合させて見ましょう。データフレームの結合には`dplyr::inner_join`関数を使います。`dplyr::inner_join`関数は二つのデータフレームの双方にあるデータをキーに結合を行います。
```{r, eval=FALSE}

```

### Join
```{r inner_join, exercise=TRUE, exercise.setup="common", exercise.lines=18, message=FALSE}
sum_tbl <- bugs %>% 
  dplyr::select('#', 'トラッカー', 'ステータス', '作成日') %>% 
  dplyr::rename(ID = '#', Tracker = 'トラッカー', Status = 'ステータス',
                DateTime = '作成日') %>% 
  dplyr::mutate(Date = lubridate::as_date(DateTime)) %>% 
  dplyr::count(Date) %>% 
  dplyr::mutate(Cum = cumsum(n)) %>% 
  dplyr::rename(Sum = n)

bugs %>% 
  dplyr::select('#', 'トラッカー', 'ステータス', '作成日') %>% 
  dplyr::rename(ID = '#', Tracker = 'トラッカー', Status = 'ステータス',
                DateTime = '作成日') %>% 
  dplyr::mutate(Date = lubridate::as_date(DateTime)) %>% 
  dplyr::count(Date, Status) %>% 
  tidyr::spread(key = Status, value = n) %>% 
  dplyr::inner_join(sum_tbl)
```

## Tidy/Gather
```{r, eval=FALSE}
tidyr::gather()
```

### 重ね合わせグラフ
```{r, eval=FALSE}
bugs %>% 
  dplyr::select('#', 'トラッカー', 'ステータス', '作成日') %>% 
  dplyr::rename(ID = '#', Tracker = 'トラッカー', Status = 'ステータス',
                DateTime = '作成日') %>% 
  dplyr::mutate(Date = lubridate::as_date(DateTime)) %>% 
  dplyr::count(Date, Status) %>% 
  ggplot2::ggplot(aes(x = Date)) +
    ggplot2::geom_bar(aes(y = n, fill = Status), stat = "identity")

bugs %>% 
  dplyr::select('#', 'トラッカー', 'ステータス', '作成日') %>% 
  dplyr::rename(ID = '#', Tracker = 'トラッカー', Status = 'ステータス',
                DateTime = '作成日') %>% 
  dplyr::mutate(Date = lubridate::as_date(DateTime)) %>% 
  dplyr::count(Date) %>% 
  dplyr::mutate(Cum = cumsum(n)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = Date)) + 
    ggplot2::geom_line(aes(y = Cum)) + 
    ggplot2::geom_bar(aes(y = n), stat = "identity")

bugs %>% 
  dplyr::select('#', 'トラッカー', 'ステータス', '作成日') %>% 
  dplyr::rename(ID = '#', Tracker = 'トラッカー', Status = 'ステータス',
                DateTime = '作成日') %>% 
  dplyr::mutate(Date = lubridate::as_date(DateTime)) %>% 
  ggplot2::ggplot(aes(x = Date, fill = Status)) + 
    ggplot2::geom_bar()

```

### Gather
```{r, eval=FALSE, include=FALSE}
# ステータス別累計グラフ
bugs %>% 
  dplyr::select('#', 'トラッカー', 'ステータス', '作成日') %>% 
  dplyr::rename(ID = '#', Tracker = 'トラッカー', Status = 'ステータス',
                DateTime = '作成日') %>% 
  dplyr::mutate(Date = lubridate::as_date(DateTime)) %>% 
  dplyr::group_by(Date, Status) %>% 
  dplyr::tally() %>% 
  tidyr::spread(key = Status, value = n) %>% 
  dplyr::ungroup() %>%
  dplyr::mutate_at(vars(-Date), funs(replace(., is.na(.), 0))) %>% 
  dplyr::mutate_if(is.numeric, cumsum) %>%
  # dplyr::mutate_at(vars(-Date), funs(cumsum)) %>%
  tidyr::gather(key = Status, value = Count, -Date) %>%
  ggplot2::ggplot(aes(Date)) +
  # tibble::rowid_to_column() %>%
  # tidyr::gather(key = Status, value = Count, -Date, -rowid) %>%
  # ggplot2::ggplot(aes(rowid)) +
    ggplot2::geom_bar(aes(y = Count, fill = Status), stat = "identity") +
    ggplot2::geom_line(aes(y = Count, colour = Status), position = "stack") 

# 
bugs %>% 
  dplyr::select('#', 'トラッカー', 'ステータス', '作成日') %>% 
  dplyr::rename(ID = '#', Tracker = 'トラッカー', Status = 'ステータス',
                DateTime = '作成日') %>% 
  dplyr::mutate(Date = lubridate::as_date(DateTime)) %>% 
  dplyr::group_by(Date, Status) %>% 
  dplyr::tally() %>% 
  tidyr::spread(key = Status, value = n) %>% 
  dplyr::ungroup() %>%
  dplyr::mutate_at(vars(-Date), funs(replace(., is.na(.), 0))) %>% 
  # dplyr::mutate_if(is.numeric, cumsum) %>%
  # dplyr::mutate_at(vars(-Date), funs(cumsum)) %>%
  tidyr::gather(key = Status, value = Count, -Date) %>%
  ggplot2::ggplot(aes(Date)) +
  # tibble::rowid_to_column() %>%
  # tidyr::gather(key = Status, value = Count, -Date, -rowid) %>%
  # ggplot2::ggplot(aes(rowid)) +
    ggplot2::geom_bar(aes(y = Count), stat = "identity")

# 
bugs %>% 
  dplyr::select('#', 'トラッカー', 'ステータス', '作成日') %>% 
  dplyr::rename(ID = '#', Tracker = 'トラッカー', Status = 'ステータス',
                DateTime = '作成日') %>% 
  dplyr::mutate(Date = lubridate::as_date(DateTime)) %>% 
  dplyr::group_by(Date, Status) %>% 
  dplyr::tally() %>% 
  tidyr::spread(key = Status, value = n) %>% 
  dplyr::ungroup() %>%
  dplyr::mutate_at(vars(-Date), funs(replace(., is.na(.), 0))) %>% 
  dplyr::mutate_at(vars(-Date), funs(cumsum)) %>%
  tidyr::gather(key = Status, value = Count, -Date) %>%
  dplyr::ungroup() %>% 
  dplyr::group_by(Date) %>% 
  dplyr::tally(Count) %>% 
  ggplot2::ggplot(aes(x = Date)) +
    ggplot2::geom_line(aes(y = n)) 
```


### Cross Table
クロス集計結果に度数欄と累積度数を追加してみましょう。
```{r pivot, exercise=TRUE, exercise.setup="common"}
sum_date <- bugs %>%
  dplyr::group_by(date) %>%
  dplyr::count(date)

bugs_tbl <- bugs %>%
  dplyr::group_by(date, rank) %>%
  dplyr::count(date) %>% 
  tidyr::spread(key = rank, value = n)

bugs_tbl %>%
  dplyr::inner_join(sum_date) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Cum = cumsum(n)) %>% 
  dplyr::rename(Sum = n)
```

```{r pivot-hint}
sum_date <- bugs %>%
  dplyr::group_by(date) %>%
  dplyr::count(date)

bugs_tbl <- bugs %>%
  dplyr::group_by(date, rank) %>%
  dplyr::count(date) %>% 
  tidyr::spread(key = rank, value = n)

bugs_tbl %>%
  dplyr::inner_join(sum_date) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Cum = cumsum(n)) %>% 
  dplyr::rename(Sum = n)
```

### 列集計

## dplyr
http://dplyr.tidyverse.org/


---
![Sampo Suzuki][CCI]
[CC BY-NC-SA 4.0][CC], Sampo Suzuki [`r format(Sys.time(), format = '%F %H:%M(%Z)')`]

<!-- Creative Commons -->
[CC]: http://creativecommons.org/licenses/by-nc-sa/4.0/deed.ja "CC BY-NC-SA 4.0"
[CCI]: https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png "CC BY-NC-SA 4.0 icon"

<!-- R -->
[R]: https://www.r-project.org/ "The R Project"
[CRAN]: https://cran.r-project.org/ "CRAN"
[ISM]: https://cran.ism.ac.jp/ "CRAN ISM"

<!-- RStudio -->
[RS]: https://www.rstudio.com/ "RStudio"
[RSD]: https://www.rstudio.com/products/RStudio/#Desktop "RStudio Desktop"
[RSS]: https://www.rstudio.com/products/RStudio/#Server "RStudio Server"
[RM]: http://rmarkdown.rstudio.com/ "R Markdown form RStudio"
[RSH]: https://github.com/rstudio/RStartHere "R Start Here"
[R4DS]: http://r4ds.had.co.nz/ "R for Data Science"

<!-- Packages -->
[DT]: https://rstudio.github.io/DT/ "An R interface to the DataTables library"
[formatr]: https://yihui.name/formatr/ "Format R code automatically"
[knitr]: https://yihui.name/knitr/ "Elegant, flexible and fast dynamic report generation with R"
[learnr]: https://rstudio.github.io/learnr/ "Interactive Tutorials for R"
[shiny]: https://shiny.rstudio.com/ "Shiny by RStudio"
[tidy]: http://tidyverse.org/ "The tidyverse"

