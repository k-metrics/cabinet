---
title: "ggplot2のすゝめ"
author-meta: "k-metrics"
output: 
  html_document:  
    code_folding: show
    highlight: textmate
    md_extensions: -ascii_identifiers
    number_section: yes
    theme: cerulean
---

<!-- Common Links -->
```{r r basics, child="../../common/links.Rmd", include=FALSE}
```

```{r setup, include=FALSE}
# 共通chunkオプションの指定
knitr::opts_chunk$set(warning = FALSE, echo = TRUE)

# データハンドリングで利用する外部パッケージの読み込み
require(tidyverse)
# 表示で利用する外部パッケージの読み込み
require(gridExtra)
require(DT)
require(knitr)
tidyverse::tidyverse_conflicts()

# ローカル定義関数の読み込み
source("../../common/common.R")
```

---

# はじめに {.unnumbered}
Rが描いてくれるグラフは便利で分かりやすいのですが、反面、色気がないとか、パラメータの指定方法が統一的でないとか、重ね合わせをするのが面倒であるとか、色々と細かい不満があります。

```{r}
plot(iris$Sepal.Width, iris$Sepal.Length)

boxplot(iris$Sepal.Length ~ iris$Species)
```

そこで、データハンドリングで処理したデータフレームを統一的な文法でグラフ化できる`ggplot2`パッケージの出番です。`ggplot2`パッケージは`tidyverse`パッケージの一部であり、`dplyr`パッケージや`tidyr`パッケージで整形した整然データ（Tidy Data）をそのまま扱えます。

```{r}
iris %>% 
  ggplot2::ggplot(aes(x = Sepal.Width, y = Sepal.Length)) +
    ggplot2::geom_point()

iris %>% 
  ggplot2::ggplot(aes(x = Species, y = Sepal.Length)) +
    ggplot2::geom_boxplot()
```

このように`ggplot2`パッケージでは散布図も箱ひげ図も同じ文法で描け、以下のような特徴があります。

* グラフの種類が違っても引数の指定方法は同じ
* グラフの重ね合わせや層別での色分けも簡単
* 描画範囲はデータから自動的に判断
* テーマ機能でお好みのカラーリングに
* グラッフィクパッケージなのでグラフ以外も扱える

# 基本的な使い方
`ggplot2`の文法は非常にシンプルです。まず、データと座標を用意し、その上に描きたいコンポーネントを重ねていくイメージです。GIS（地理情報システム）やPhotoshopにおけるレイヤー機能と同じような考え方です。先程の描画の例では
```{r}
iris %>% 
  ggplot2::ggplot(aes(x = Sepal.Width, y = Sepal.Length)) +
    ggplot2::geom_point()
```

上から順に

* 可視化したいデータを指定する
* x軸とy軸の変数を指定して座標を作る
* 散布図を描く

となっています。

## タイトルをつける
更にこのグラフにタイトルをつける場合は、`ggplot2::ggtitle`関数を用いて以下のように指定します。
```{r}
iris %>% 
  ggplot2::ggplot(aes(x = Sepal.Width, y = Sepal.Length)) +
    ggplot2::geom_point() +
    ggplot2::ggtitle("みんな大好きiris")
```

## 軸ラベルを変更する
更に軸のラベルを変更するには`ggplot2::xlab`、`ggplot2::ylab`関数を用いて以下のように指定します。
```{r}
iris %>% 
  ggplot2::ggplot(aes(x = Sepal.Width, y = Sepal.Length)) +
    ggplot2::geom_point() +
    ggplot2::ggtitle("みんな大好きiris") +
    ggplot2::xlab("がく片の幅") + ggplot2::ylab("がく片の長さ")
```

## 層別にプロットする
種別（`Species`）毎に色分けしたい場合は`ggplot2::geom_point`関数で色分けを指定します。
```{r}
iris %>% 
  ggplot2::ggplot(aes(x = Sepal.Width, y = Sepal.Length)) +
    ggplot2::geom_point(aes(colour = Species)) +
    ggplot2::ggtitle("みんな大好きiris") +
    ggplot2::xlab("がく片の幅") + ggplot2::ylab("がく片の長さ")
```

## 回帰直線を描く
ここに回帰直線を加えてみましょう。
```{r}
iris %>% 
  ggplot2::ggplot(aes(x = Sepal.Width, y = Sepal.Length)) +
    ggplot2::geom_point(aes(colour = Species)) +
    ggplot2::ggtitle("みんな大好きiris") +
    ggplot2::xlab("がく片の幅") + ggplot2::ylab("がく片の長さ") +
    ggplot2::geom_smooth(method = "lm", se = FALSE)
```

## 信頼区間を加える
信頼区間も加えてみると
```{r}
iris %>% 
  ggplot2::ggplot(aes(x = Sepal.Width, y = Sepal.Length)) +
    ggplot2::geom_point(aes(colour = Species)) +
    ggplot2::ggtitle("みんな大好きiris") +
    ggplot2::xlab("がく片の幅") + ggplot2::ylab("がく片の長さ") +
    ggplot2::geom_smooth(method = "lm", se = TRUE)
```

## 層別の回帰直線を描く
折角なので層別に回帰直線と信頼区間を描いてみましょう。
```{r}
iris %>% 
  ggplot2::ggplot(aes(x = Sepal.Width, y = Sepal.Length, colour = Species)) +
    ggplot2::geom_point() +
    ggplot2::ggtitle("みんな大好きiris") +
    ggplot2::xlab("がく片の幅") + ggplot2::ylab("がく片の長さ") +
    ggplot2::geom_smooth(method = "lm", se = TRUE)
```

## 軸の比率を変更する
見やすくx軸とy軸の比散るを同じにするには
```{r}
iris %>% 
  ggplot2::ggplot(aes(x = Sepal.Width, y = Sepal.Length, colour = Species)) +
    ggplot2::geom_point() +
    ggplot2::ggtitle("みんな大好きiris") +
    ggplot2::xlab("がく片の幅") + ggplot2::ylab("がく片の長さ") +
    ggplot2::geom_smooth(method = "lm", se = TRUE) +
    ggplot2::coord_fixed(ratio = 1)
```

## 対数軸を用いる
データの範囲が狭いのでちょっと見難いですが対数軸で表示すると補助線の感覚が異なってることが分かります。
```{r}
iris %>% 
  ggplot2::ggplot(aes(x = Sepal.Width, y = Sepal.Length, colour = Species)) +
    ggplot2::geom_point() +
    ggplot2::ggtitle("みんな大好きiris") +
    ggplot2::xlab("がく片の幅") + ggplot2::ylab("がく片の長さ") +
    ggplot2::geom_smooth(method = "lm", se = TRUE) +
    ggplot2::coord_trans(x = "log10", y = "log10")
```

## 背景を変える
グラフの背景色をなくして表示をシンプルにするには
```{r}
iris %>% 
  ggplot2::ggplot(aes(x = Sepal.Width, y = Sepal.Length, colour = Species)) +
    ggplot2::geom_point() +
    ggplot2::ggtitle("みんな大好きiris") +
    ggplot2::xlab("がく片の幅") + ggplot2::ylab("がく片の長さ") +
    ggplot2::geom_smooth(method = "lm", se = TRUE) +
    ggplot2::theme_bw()
```

# 理解のポイント

---

<!-- Footer -->

```{r child="../../common/footer.Rmd"}
```


[PB1]: https://cran.r-project.org/web/packages/available_packages_by_name.html "CRAN Packages List"
[PB2]: http://www.trifields.jp/statistical-analysis-r-cran-packages-341 "CRANパッケージリスト"
[PB3]: https://cran.r-project.org/web/views/ "CRAN Task View"
[PB4]: http://www.trifields.jp/r-cran-task-views-639 "CRAN Task View"

