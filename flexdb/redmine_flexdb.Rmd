---
title: "Redmine project in 2018"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    # theme: flatly
---

```{r setup, include=FALSE}
require(DT)
require(flexdashboard)
require(plotly)
# require(redmineR)
require(tidyverse)    # tidyverseは最後に呼び出す方がコンフリクトの影響小

# Local Function
map_if_chr <- function(.x, .f) {
  purrr::map_if(.x, !is.na(.x), .f) %>% 
    purrr::map_chr(1L) %>% return()
}

# Issuesの事前展開
load("./_redmine_issues_all.RData_")

issues_2018 <- issues %>% 
  dplyr::select(id, created_on, closed_on, tracker, status, priority,
                category, author, assigned_to, subject) %>% 
  dplyr::mutate_if(is.list, map_if_chr, 'name') %>% 
  dplyr::mutate(open = lubridate::as_date(created_on),
                close = lubridate::as_date(closed_on)) %>% 
  dplyr::select(-created_on, -closed_on) %>% 
  dplyr::filter(open >= "2018-1-1")

# カテゴリの編集
issues_2018 <- issues_2018 %>% 
  dplyr::mutate(tracker = as.factor(tracker),
                tracker = forcats::fct_relevel(tracker, "Defect", "Patch",
                                               "Feature")) %>% 
  dplyr::mutate(status = as.factor(status),
                status = forcats::fct_relevel(status, "New", "Reopened",
                                              "Needs feedback", "Confirmed",
                                              "Resolved", "Closed")) %>% 
  dplyr::mutate(priority = as.factor(priority),
                priority = forcats::fct_relevel(priority, "Urgent", "High",
                                                "Normal", "Low")) %>% 
  dplyr::mutate(category = as.factor(category),
                category = fct_collapse(category,
                                        Category_A = c("Accounts / authentication", "Activity view", "Administration", "Attachments"),
                                        Category_C = c("Calendar", "Code cleanup/refactoring", "Custom fields"),
                                        Category_D = c("Database", "Documentation", "Documents"),
                                        Category_E = c("Email notifications", "Email receiving"),
                                        Category_F = c("Files", "Forums"),
                                        Category_G = c("Gantt", "Gems support", "Groups"),
                                        Category_H = c("Hook requests"),
                                        Category_I = c("I18n", "Importers", "Issues", "Issues filter", "Issues list", "Issues permissions", "Issues planning", "Issues workflow"),
                                        Category_L = c("LDAP"),
                                        Category_M = c("My page"),
                                        Category_P = c("PDF export", "Performance", "Permissions and roles", "Plugin API", "Plugin Request", "Project settings", "Projects"),
                                        Category_R = c("REST API", "Rails support", "Roadmap", "Ruby support"),
                                        Category_S = c("SCM", "SEO", "Search engine", "Security"),
                                        Category_T = c("Text formatting", "Themes", "Third-party libraries", "Time tracking", "Translations"),
                                        Category_U = c("UI", "UI - Responsive"),
                                        Category_W = c("Website (redmine.org)" , "Wiki")))
                  
summarytools::view(summarytools::dfSummary(issues_2018, plain.ascii = FALSE,
                                           style = "grid"),
                   method = 'render', omit.headings = TRUE)

# 基準となる週番号
weeks <- data.frame(week = c(1:53))
```

# Summary

## Coloumn L {data-width=100}

### Overall
```{r}
all <- issues_2018 %>% 
  dplyr::count()

closed <- issues_2018 %>% 
  # dplyr::filter(status == "Resolved" | status == "Closed") %>% 
  dplyr::filter(status == "Closed") %>% 
  dplyr::count()

rate <- round((closed$n / all$n) * 100, 1)

flexdashboard::gauge(rate, min = 0, max = 100, symbol = '%', label = "Closed Rate",
                     flexdashboard::gaugeSectors(success = c(80, 100),
                                                 warning = c(40, 79),
                                                 danger = c(0, 39)))
```

### Defect
```{r defect_closed}
all <- issues_2018 %>% 
  dplyr::filter(tracker == "Defect") %>% 
  dplyr::count()

closed <- issues_2018 %>% 
  # dplyr::filter(tracker == "Defect" & (status == "Resolved" | status == "Closed")) %>% 
  dplyr::filter(tracker == "Defect" & (status == "Closed")) %>% 
  dplyr::count()

rate <- round((closed$n / all$n) * 100, 1)

flexdashboard::gauge(rate, min = 0, max = 100, symbol = '%', label = "Closed Rate",
                     flexdashboard::gaugeSectors(success = c(80, 100),
                                                 warning = c(40, 79),
                                                 danger = c(0, 39)))
```

### Patch
```{r patch_closed}
all <- issues_2018 %>% 
  dplyr::filter(tracker == "Patch") %>% 
  dplyr::count()

closed <- issues_2018 %>% 
  # dplyr::filter(tracker == "Patch" & (status == "Resolved" | status == "Closed")) %>% 
  dplyr::filter(tracker == "Patch" & (status == "Closed")) %>% 
  dplyr::count()

rate <- round((closed$n / all$n) * 100, 1)

flexdashboard::gauge(rate, min = 0, max = 100, symbol = '%', label = "Closed Rate",
                     flexdashboard::gaugeSectors(success = c(80, 100),
                                                 warning = c(40, 79),
                                                 danger = c(0, 39)))
```

### Feature
```{r feature_closed}
all <- issues_2018 %>% 
  dplyr::filter(tracker == "Feature") %>% 
  dplyr::count()

closed <- issues_2018 %>% 
  # dplyr::filter(tracker == "Feature" & (status == "Resolved" | status == "Closed")) %>% 
  dplyr::filter(tracker == "Feature" & (status == "Closed")) %>% 
  dplyr::count()

rate <- round((closed$n / all$n) * 100, 1)

flexdashboard::gauge(rate, min = 0, max = 100, symbol = '%', label = "Closed Rate",
                     flexdashboard::gaugeSectors(success = c(80, 100),
                                                 warning = c(40, 79),
                                                 danger = c(0, 39)))
```


## Column M {data-width=450}

### Overall
```{r}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::mutate(flag = dplyr::if_else(status == "Closed", as.character(status), "Open"),
                open = lubridate::week(open),
                close = lubridate::week(close)) %>% 
  dplyr::select(id, open, close, flag)

# チケット最終週
max_week <- max(tmp_issues$open, tmp_issues$close, na.rm = TRUE)

# チケットオープンの集計
open <- tmp_issues %>% 
  dplyr::count(open) %>% 
  dplyr::rename(week = open, open = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(open = dplyr::if_else(is.na(open) & week <= max_week, 0L, open)) %>% 
  dplyr::mutate(cum_open = cumsum(open)) 

close <- tmp_issues %>% 
  dplyr::filter(flag == "Closed") %>% 
  dplyr::count(close) %>% 
  dplyr::rename(week = close, close = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(close = dplyr::if_else(is.na(close) & week <= max_week, 0L, close)) %>% 
  dplyr::mutate(cum_close = cumsum(close)) 


(open %>% 
  dplyr::full_join(close, by = "week") %>% 
  dplyr::select(week, open = cum_open, closed = cum_close) %>% 
  tidyr::gather(key = "Status", value, -week) %>% 
  dplyr::mutate(Status = as.factor(Status),
                Status = forcats::fct_relevel(Status, "open", "closed")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) + 
    ggplot2::geom_line(ggplot2::aes(y = value, colour = Status)) + 
    ggplot2::labs(y = "", title = "All issues") ) %>% 
  plotly::ggplotly()
```

### Defect
```{r defect_openclose}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::filter(tracker == "Defect") %>% 
  dplyr::mutate(flag = dplyr::if_else(status == "Closed", as.character(status), "Open"),
                open = lubridate::week(open),
                close = lubridate::week(close)) %>% 
  dplyr::select(id, open, close, flag)

# チケット最終週
max_week <- max(tmp_issues$open, tmp_issues$close, na.rm = TRUE)

# チケットオープンの集計
open <- tmp_issues %>% 
  dplyr::count(open) %>% 
  dplyr::rename(week = open, open = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(open = dplyr::if_else(is.na(open) & week <= max_week, 0L, open)) %>% 
  dplyr::mutate(cum_open = cumsum(open)) 

close <- tmp_issues %>% 
  dplyr::filter(flag == "Closed") %>% 
  dplyr::count(close) %>% 
  dplyr::rename(week = close, close = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(close = dplyr::if_else(is.na(close) & week <= max_week, 0L, close)) %>% 
  dplyr::mutate(cum_close = cumsum(close)) 


(open %>% 
  dplyr::full_join(close, by = "week") %>% 
  dplyr::select(week, open = cum_open, closed = cum_close) %>% 
  tidyr::gather(key = "Status", value, -week) %>% 
  dplyr::mutate(Status = as.factor(Status),
                Status = forcats::fct_relevel(Status, "open", "closed")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) + 
    ggplot2::geom_line(ggplot2::aes(y = value, colour = Status)) + 
    ggplot2::labs(y = "", title = "Defect") ) %>% 
  plotly::ggplotly()
```

### Patch
```{r patch_openclose}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::filter(tracker == "Patch") %>% 
  dplyr::mutate(flag = dplyr::if_else(status == "Closed", as.character(status), "Open"),
                open = lubridate::week(open),
                close = lubridate::week(close)) %>% 
  dplyr::select(id, open, close, flag)

# チケット最終週
max_week <- max(tmp_issues$open, tmp_issues$close, na.rm = TRUE)

# チケットオープンの集計
open <- tmp_issues %>% 
  dplyr::count(open) %>% 
  dplyr::rename(week = open, open = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(open = dplyr::if_else(is.na(open) & week <= max_week, 0L, open)) %>% 
  dplyr::mutate(cum_open = cumsum(open)) 

close <- tmp_issues %>% 
  dplyr::filter(flag == "Closed") %>% 
  dplyr::count(close) %>% 
  dplyr::rename(week = close, close = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(close = dplyr::if_else(is.na(close) & week <= max_week, 0L, close)) %>% 
  dplyr::mutate(cum_close = cumsum(close)) 

(open %>% 
  dplyr::full_join(close, by = "week") %>% 
  dplyr::select(week, open = cum_open, closed = cum_close) %>% 
  tidyr::gather(key = "Status", value, -week) %>% 
  dplyr::mutate(Status = as.factor(Status),
                Status = forcats::fct_relevel(Status, "open", "closed")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) + 
    ggplot2::geom_line(ggplot2::aes(y = value, colour = Status)) + 
    ggplot2::labs(y = "", title = "Patch") ) %>% 
  plotly::ggplotly()
```

### Feature
```{r feature_openclose}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::filter(tracker == "Feature") %>% 
  dplyr::mutate(flag = dplyr::if_else(status == "Closed", as.character(status), "Open"),
                open = lubridate::week(open),
                close = lubridate::week(close)) %>% 
  dplyr::select(id, open, close, flag)

# チケット最終週
max_week <- max(tmp_issues$open, tmp_issues$close, na.rm = TRUE)

# チケットオープンの集計
open <- tmp_issues %>% 
  dplyr::count(open) %>% 
  dplyr::rename(week = open, open = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(open = dplyr::if_else(is.na(open) & week <= max_week, 0L, open)) %>% 
  dplyr::mutate(cum_open = cumsum(open)) 

close <- tmp_issues %>% 
  dplyr::filter(flag == "Closed") %>% 
  dplyr::count(close) %>% 
  dplyr::rename(week = close, close = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(close = dplyr::if_else(is.na(close) & week <= max_week, 0L, close)) %>% 
  dplyr::mutate(cum_close = cumsum(close)) 


(open %>% 
  dplyr::full_join(close, by = "week") %>% 
  dplyr::select(week, open = cum_open, closed = cum_close) %>% 
  tidyr::gather(key = "Status", value, -week) %>% 
  dplyr::mutate(Status = as.factor(Status),
                Status = forcats::fct_relevel(Status, "open", "closed")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) + 
    ggplot2::geom_line(ggplot2::aes(y = value, colour = Status)) + 
    ggplot2::labs(y = "", title = "Feature") ) %>% 
  plotly::ggplotly()
```



## Coloumn R {data-width=450} {.tabset}

### Overall
```{r}
issues_2018 %>% 
  dplyr::count(status, priority) %>% 
  tidyr::spread(priority, n) %>% knitr::kable(caption = "All isseues")
  # DT::datatable(caption = "All issues")
```

```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Defect") %>% 
  dplyr::count(status, priority) %>% 
  tidyr::spread(priority, n) %>% knitr::kable(caption = "Defect issues")
  # DT::datatable(caption = "Defect issues")
```

```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Patch") %>% 
  dplyr::count(status, priority) %>% 
  tidyr::spread(priority, n) %>% knitr::kable(caption = "Patch issues")
  # DT::datatable(caption = "Defect issues")
```

```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Feature") %>% 
  dplyr::count(status, priority) %>% 
  tidyr::spread(priority, n) %>% knitr::kable(caption = "Feature issues")
  # DT::datatable(caption = "Defect issues")
```


### New issues
```{r, echo=FALSE}
issues_2018 %>% 
  dplyr::filter(status == "New") %>% 
  dplyr::select(id, open, tracker, priority, category, subject) %>% 
  DT::datatable(options = list(pageLength = 15))
```


### Staying
```{r, message = FALSE, warning=FALSE}
(issues_2018 %>% 
  dplyr::filter(status != "Closed") %>% 
  dplyr::mutate(days = lubridate::today() - open + 1) %>% 
  ggplot2::ggplot(ggplot2::aes(x = days, fill = tracker)) + 
    ggplot2::geom_histogram(alpha = 0.6, position = "identity") +
    # ggplot2::geom_histogram(alpha = 0.6, position = "stack") + 
    ggplot2::labs(x = "滞留日数", y = "", title = "Open issues")) %>% 
  plotly::ggplotly()
```


# Defect

## Coloumn L {data-width=100}

### Defect
```{r, ref.label="defect_closed"}

```

### New
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Defect" & status == "New") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "New", color = "danger")
```

### Reopened
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Defect" & status == "Responsed") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Reopened", color = "danger")
```

### Needs feedback
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Defect" & status == "Needs feedback") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Needs feedback", color = "warning")
```

### Confirmed
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Defect" & status == "Confirmed") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Confirmed", color = "primary")
```

### Resolved
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Defect" & status == "Resolved") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Resolved", color = "primary")
```

### Closed
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Defect" & status == "Closed") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Closed", color = "success")
```


## Coloumn M {data-width=450}

### Open-Close
```{r, ref.label="defect_openclose"}

```


## Coloumn R {data-width=450}
```{r}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::filter(tracker == "Defect") %>% 
  dplyr::mutate(flag = dplyr::if_else(status == "Closed", as.character(status), "Open"),
                open = lubridate::week(open),
                close = lubridate::week(close)) %>% 
  dplyr::select(id, open, close, flag)

# チケット最終週
max_week <- max(tmp_issues$open, tmp_issues$close, na.rm = TRUE)
```


### Weekly open
```{r}
# チケットオープンの集計
open <- tmp_issues %>% 
  dplyr::count(open) %>% 
  dplyr::rename(week = open, open = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(open = dplyr::if_else(is.na(open) & week <= max_week, 0L, open)) %>% 
  dplyr::mutate(cum_open = cumsum(open), diff = open - dplyr::lag(open)) 

(open %>% 
  dplyr::mutate(diff_offset = diff + round(mean(open, na.rm = TRUE))) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) +
    ggplot2::geom_bar(ggplot2::aes(y = open), stat = "identity", alpha = 0.25) + 
    ggplot2::geom_hline(yintercept = round(mean(open$open, na.rm = TRUE), 1),
                        colour = "#f8766d", linetype = "dashed") + 
    ggplot2::geom_line(ggplot2::aes(y = diff_offset), colour = "#f8766d",
                       size = 0.75)) %>% 
  plotly::ggplotly()
```


### Weekly closed
```{r}
close <- tmp_issues %>% 
  dplyr::filter(flag == "Closed") %>% 
  dplyr::count(close) %>% 
  dplyr::rename(week = close, close = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(close = dplyr::if_else(is.na(close) & week <= max_week, 0L, close)) %>% 
  dplyr::mutate(cum_close = cumsum(close), diff = close - dplyr::lag(close))

(close %>% 
  dplyr::mutate(diff_offset = diff + round(mean(close, na.rm = TRUE)), 1) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) +
    ggplot2::geom_bar(ggplot2::aes(y = close), stat = "identity", alpha = 0.25) + 
    ggplot2::geom_hline(yintercept = round(mean(close$close, na.rm = TRUE)),
                        colour = "#00bfc4", linetype = "dashed") + 
    ggplot2::geom_line(ggplot2::aes(y = diff_offset), colour = "#00bfc4",
                       size = 0.75)) %>% 
  plotly::ggplotly()
```



# Patch
## Coloumn L {data-width=100}

### Patch
```{r, ref.label="patch_closed"}

```

### New
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Patch" & status == "New") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "New", color = "danger")
```

### Reopened
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Patch" & status == "Responsed") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Reopened", color = "danger")
```

### Needs feedback
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Patch" & status == "Needs feedback") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Needs feedback", color = "warning")
```

### Confirmed
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Patch" & status == "Confirmed") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Confirmed", color = "primary")
```

### Resolved
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Patch" & status == "Resolved") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Resolved", color = "primary")
```

### Closed
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Patch" & status == "Closed") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Closed", color = "success")
```

## Coloumn M {data-width=450}

### Overall
```{r, ref.label="patch_openclose"}

```


## Coloumn R {data-width=450}
```{r}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::filter(tracker == "Patch") %>% 
  dplyr::mutate(flag = dplyr::if_else(status == "Closed", as.character(status), "Open"),
                open = lubridate::week(open),
                close = lubridate::week(close)) %>% 
  dplyr::select(id, open, close, flag)

# チケット最終週
max_week <- max(tmp_issues$open, tmp_issues$close, na.rm = TRUE)
```


### Weekly open
```{r}
# チケットオープンの集計
open <- tmp_issues %>% 
  dplyr::count(open) %>% 
  dplyr::rename(week = open, open = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(open = dplyr::if_else(is.na(open) & week <= max_week, 0L, open)) %>% 
  dplyr::mutate(cum_open = cumsum(open), diff = open - dplyr::lag(open)) 

(open %>% 
  dplyr::mutate(diff_offset = diff + round(mean(open, na.rm = TRUE))) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) +
    ggplot2::geom_bar(ggplot2::aes(y = open), stat = "identity", alpha = 0.25) + 
    ggplot2::geom_hline(yintercept = round(mean(open$open, na.rm = TRUE), 1),
                        colour = "#f8766d", linetype = "dashed") + 
    ggplot2::geom_line(ggplot2::aes(y = diff_offset), colour = "#f8766d",
                       size = 0.75)) %>% 
  plotly::ggplotly()
```


### Weekly closed
```{r}
close <- tmp_issues %>% 
  dplyr::filter(flag == "Closed") %>% 
  dplyr::count(close) %>% 
  dplyr::rename(week = close, close = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(close = dplyr::if_else(is.na(close) & week <= max_week, 0L, close)) %>% 
  dplyr::mutate(cum_close = cumsum(close), diff = close - dplyr::lag(close))

(close %>% 
  dplyr::mutate(diff_offset = diff + round(mean(close, na.rm = TRUE)), 1) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) +
    ggplot2::geom_bar(ggplot2::aes(y = close), stat = "identity", alpha = 0.25) + 
    ggplot2::geom_hline(yintercept = round(mean(close$close, na.rm = TRUE)),
                        colour = "#00bfc4", linetype = "dashed") + 
    ggplot2::geom_line(ggplot2::aes(y = diff_offset), colour = "#00bfc4",
                       size = 0.75)) %>% 
  plotly::ggplotly()
```



# Feature

## Coloumn L {data-width=100}

### Feature
```{r, ref.label="feature_closed"}

```

### New
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Feature" & status == "New") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "New", color = "danger")
```

### Reopened
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Feature" & status == "Responsed") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Reopened", color = "danger")
```

### Needs feedback
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Feature" & status == "Needs feedback") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Needs feedback", color = "warning")
```

### Confirmed
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Feature" & status == "Confirmed") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Confirmed", color = "primary")
```

### Resolved
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Feature" & status == "Resolved") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Resolved", color = "primary")
```

### Closed
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Feature" & status == "Closed") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Closed", color = "success")
```

## Coloumn M {data-width=450}

### Overall
```{r, ref.label="feature_openclose"}

```


## Coloumn R {data-width=450}
```{r}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::filter(tracker == "Feature") %>% 
  dplyr::mutate(flag = dplyr::if_else(status == "Closed", as.character(status), "Open"),
                open = lubridate::week(open),
                close = lubridate::week(close)) %>% 
  dplyr::select(id, open, close, flag)

# チケット最終週
max_week <- max(tmp_issues$open, tmp_issues$close, na.rm = TRUE)
```


### Weekly open
```{r}
# チケットオープンの集計
open <- tmp_issues %>% 
  dplyr::count(open) %>% 
  dplyr::rename(week = open, open = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(open = dplyr::if_else(is.na(open) & week <= max_week, 0L, open)) %>% 
  dplyr::mutate(cum_open = cumsum(open), diff = open - dplyr::lag(open)) 

(open %>% 
  dplyr::mutate(diff_offset = diff + round(mean(open, na.rm = TRUE))) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) +
    ggplot2::geom_bar(ggplot2::aes(y = open), stat = "identity", alpha = 0.25) + 
    ggplot2::geom_hline(yintercept = round(mean(open$open, na.rm = TRUE), 1),
                        colour = "#f8766d", linetype = "dashed") + 
    ggplot2::geom_line(ggplot2::aes(y = diff_offset), colour = "#f8766d",
                       size = 0.75)) %>% 
  plotly::ggplotly()
```


### Weekly closed
```{r}
close <- tmp_issues %>% 
  dplyr::filter(flag == "Closed") %>% 
  dplyr::count(close) %>% 
  dplyr::rename(week = close, close = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(close = dplyr::if_else(is.na(close) & week <= max_week, 0L, close)) %>% 
  dplyr::mutate(cum_close = cumsum(close), diff = close - dplyr::lag(close))

(close %>% 
  dplyr::mutate(diff_offset = diff + round(mean(close, na.rm = TRUE)), 1) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) +
    ggplot2::geom_bar(ggplot2::aes(y = close), stat = "identity", alpha = 0.25) + 
    ggplot2::geom_hline(yintercept = round(mean(close$close, na.rm = TRUE)),
                        colour = "#00bfc4", linetype = "dashed") + 
    ggplot2::geom_line(ggplot2::aes(y = diff_offset), colour = "#00bfc4",
                       size = 0.75)) %>% 
  plotly::ggplotly()
```
