---
title: "Redmine project in 2018"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: flatly
---

<!-- "default", "cerulean", "journal", "flatly", "readable", "spacelab", "united", "cosmo", "lumen", "paper", "sandstone", "simplex", "yeti" -->

```{r setup, include=FALSE}
require(DT)
require(flexdashboard)
require(plotly)
# require(redmineR)
require(skimr)
require(tidyverse)    # tidyverseは最後に呼び出す方がコンフリクトの影響小

# Local Function
map_if_chr <- function(.x, .f) {
  purrr::map_if(.x, !is.na(.x), .f) %>% 
    purrr::map_chr(1L) %>% return()
}

# Issuesの事前展開
# load("./_redmine_issues_all.RData_")
load("./redmine_issues_all_1114.RData")

issues_2018_org <- issues %>% 
  dplyr::select(id, created_on, closed_on, updated_on, tracker, status,
                priority, category, author, assigned_to, subject,
                fixed_version) %>% 
  dplyr::mutate_if(is.list, map_if_chr, 'name') %>% 
  dplyr::mutate(open = lubridate::as_date(created_on),
                close = lubridate::as_date(closed_on),
                update = lubridate::as_date(updated_on)) %>% 
  dplyr::mutate(created_on = lubridate::ymd_hms(created_on),
                closed_on = lubridate::ymd_hms(closed_on),
                updated_on = lubridate::ymd_hms(updated_on)) %>% 
  dplyr::mutate(open_h = lubridate::hour(created_on),
                close_h = lubridate::hour(closed_on),
                update_h = lubridate::hour(updated_on)) %>% 
  tidyr::replace_na(list(category = "Uncategorized")) %>% 
  # dplyr::select(-created_on, -closed_on) %>%
  dplyr::filter(open >= "2018-1-1")

# カテゴリの編集
issues_2018 <- issues_2018_org %>% 
  dplyr::mutate(sub_category = category) %>% 
  dplyr::mutate(tracker = as.factor(tracker),
                tracker = forcats::fct_relevel(tracker, "Defect", "Patch",
                                               "Feature")) %>% 
  dplyr::mutate(status = as.factor(status),
                status = forcats::fct_relevel(status, "New", "Reopened",
                                              "Needs feedback", "Confirmed",
                                              "Resolved", "Closed")) %>% 
  dplyr::mutate(priority = as.factor(priority),
                priority = forcats::fct_relevel(priority, "Urgent", "High",
                                                "Normal", "Low")) %>% 
  dplyr::mutate(category = as.factor(category),
                category = fct_collapse(category,
                                        `Cat_A` = c("Accounts / authentication", "Activity view", "Administration", "Attachments"),
                                        `Cat_C` = c("Calendar", "Code cleanup/refactoring", "Custom fields"),
                                        `Cat_D` = c("Database", "Documentation", "Documents"),
                                        `Cat_E` = c("Email notifications", "Email receiving"),
                                        `Cat_F` = c("Files", "Forums"),
                                        `Cat_G` = c("Gantt", "Gems support", "Groups"),
                                        `Cat_H` = c("Hook requests"),
                                        `Cat_I` = c("I18n", "Importers", "Issues", "Issues filter", "Issues list", "Issues permissions", "Issues planning", "Issues workflow"),
                                        `Cat_L` = c("LDAP"),
                                        `Cat_M` = c("My page"),
                                        `Cat_P` = c("PDF export", "Performance", "Permissions and roles", "Plugin API", "Plugin Request", "Project settings", "Projects"),
                                        `Cat_R` = c("REST API", "Rails support", "Roadmap", "Ruby support"),
                                        `Cat_S` = c("SCM", "SEO", "Search engine", "Security"),
                                        `Cat_T` = c("Text formatting", "Themes", "Third-party libraries", "Time tracking", "Translations"),
                                        `Cat_U` = c("UI", "UI - Responsive"),
                                        `Cat_W` = c("Website (redmine.org)" , "Wiki")))

# summarytools::view(summarytools::dfSummary(issues_2018, plain.ascii = FALSE,
#                                            style = "grid"),
#                    method = 'render', omit.headings = TRUE)

# 基準となる週番号
weeks <- data.frame(week = c(1:53))
```

# Summary

## Coloumn L {data-width=100}

### Overall
```{r}
all <- issues_2018 %>% 
  dplyr::count()

closed <- issues_2018 %>% 
  # dplyr::filter(status == "Resolved" | status == "Closed") %>% 
  dplyr::filter(status == "Closed") %>% 
  dplyr::count()

rate <- round((closed$n / all$n) * 100, 1)

flexdashboard::gauge(rate, min = 0, max = 100, symbol = '%', label = "Closed Rate",
                     flexdashboard::gaugeSectors(success = c(80, 100),
                                                 warning = c(40, 79),
                                                 danger = c(0, 39)))
```

### Defect
```{r defect_closed}
all <- issues_2018 %>% 
  dplyr::filter(tracker == "Defect") %>% 
  dplyr::count()

closed <- issues_2018 %>% 
  # dplyr::filter(tracker == "Defect" & (status == "Resolved" | status == "Closed")) %>% 
  dplyr::filter(tracker == "Defect" & (status == "Closed")) %>% 
  dplyr::count()

rate <- round((closed$n / all$n) * 100, 1)

flexdashboard::gauge(rate, min = 0, max = 100, symbol = '%', label = "Closed Rate",
                     flexdashboard::gaugeSectors(success = c(80, 100),
                                                 warning = c(40, 79),
                                                 danger = c(0, 39)))
```

### Patch
```{r patch_closed}
all <- issues_2018 %>% 
  dplyr::filter(tracker == "Patch") %>% 
  dplyr::count()

closed <- issues_2018 %>% 
  # dplyr::filter(tracker == "Patch" & (status == "Resolved" | status == "Closed")) %>% 
  dplyr::filter(tracker == "Patch" & (status == "Closed")) %>% 
  dplyr::count()

rate <- round((closed$n / all$n) * 100, 1)

flexdashboard::gauge(rate, min = 0, max = 100, symbol = '%', label = "Closed Rate",
                     flexdashboard::gaugeSectors(success = c(80, 100),
                                                 warning = c(40, 79),
                                                 danger = c(0, 39)))
```

### Feature
```{r feature_closed}
all <- issues_2018 %>% 
  dplyr::filter(tracker == "Feature") %>% 
  dplyr::count()

closed <- issues_2018 %>% 
  # dplyr::filter(tracker == "Feature" & (status == "Resolved" | status == "Closed")) %>% 
  dplyr::filter(tracker == "Feature" & (status == "Closed")) %>% 
  dplyr::count()

rate <- round((closed$n / all$n) * 100, 1)

flexdashboard::gauge(rate, min = 0, max = 100, symbol = '%', label = "Closed Rate",
                     flexdashboard::gaugeSectors(success = c(80, 100),
                                                 warning = c(40, 79),
                                                 danger = c(0, 39)))
```


## Column M {data-width=450}

### Overall
```{r}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::mutate(flag = dplyr::if_else(status == "Closed", as.character(status), "Open"),
                open = lubridate::week(open),
                close = lubridate::week(close)) %>% 
  dplyr::select(id, open, close, flag)

# チケット最終週
max_week <- max(tmp_issues$open, tmp_issues$close, na.rm = TRUE)

# チケットオープンの集計
open <- tmp_issues %>% 
  dplyr::count(open) %>% 
  dplyr::rename(week = open, open = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(open = dplyr::if_else(is.na(open) & week <= max_week, 0L, open)) %>% 
  dplyr::mutate(cum_open = cumsum(open)) 

close <- tmp_issues %>% 
  dplyr::filter(flag == "Closed") %>% 
  dplyr::count(close) %>% 
  dplyr::rename(week = close, close = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(close = dplyr::if_else(is.na(close) & week <= max_week, 0L, close)) %>% 
  dplyr::mutate(cum_close = cumsum(close)) 


(open %>% 
  dplyr::full_join(close, by = "week") %>% 
  dplyr::select(week, open = cum_open, closed = cum_close) %>% 
  tidyr::gather(key = "Status", value, -week) %>% 
  dplyr::mutate(Status = as.factor(Status),
                Status = forcats::fct_relevel(Status, "open", "closed")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) + 
    ggplot2::geom_line(ggplot2::aes(y = value, colour = Status)) + 
    ggplot2::labs(y = "", title = "All issues") ) %>% 
  plotly::ggplotly()
```

### Defect
```{r defect_openclose}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::filter(tracker == "Defect") %>% 
  dplyr::mutate(flag = dplyr::if_else(status == "Closed", as.character(status), "Open"),
                open = lubridate::week(open),
                close = lubridate::week(close)) %>% 
  dplyr::select(id, open, close, flag)

# チケット最終週
max_week <- max(tmp_issues$open, tmp_issues$close, na.rm = TRUE)

# チケットオープンの集計
open <- tmp_issues %>% 
  dplyr::count(open) %>% 
  dplyr::rename(week = open, open = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(open = dplyr::if_else(is.na(open) & week <= max_week, 0L, open)) %>% 
  dplyr::mutate(cum_open = cumsum(open)) 

close <- tmp_issues %>% 
  dplyr::filter(flag == "Closed") %>% 
  dplyr::count(close) %>% 
  dplyr::rename(week = close, close = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(close = dplyr::if_else(is.na(close) & week <= max_week, 0L, close)) %>% 
  dplyr::mutate(cum_close = cumsum(close)) 


(open %>% 
  dplyr::full_join(close, by = "week") %>% 
  dplyr::select(week, open = cum_open, closed = cum_close) %>% 
  # dplyr::mutate(ratio = round(closed / open * 100, 1)) %>% 
  tidyr::gather(key = "Status", value, -week) %>% 
  dplyr::mutate(Status = as.factor(Status),
                Status = forcats::fct_relevel(Status, "open", "closed")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) + 
    ggplot2::geom_line(ggplot2::aes(y = value, colour = Status)) + 
    ggplot2::labs(y = "", title = "Defect") ) %>% 
  plotly::ggplotly()
```

### Patch
```{r patch_openclose}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::filter(tracker == "Patch") %>% 
  dplyr::mutate(flag = dplyr::if_else(status == "Closed", as.character(status), "Open"),
                open = lubridate::week(open),
                close = lubridate::week(close)) %>% 
  dplyr::select(id, open, close, flag)

# チケット最終週
max_week <- max(tmp_issues$open, tmp_issues$close, na.rm = TRUE)

# チケットオープンの集計
open <- tmp_issues %>% 
  dplyr::count(open) %>% 
  dplyr::rename(week = open, open = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(open = dplyr::if_else(is.na(open) & week <= max_week, 0L, open)) %>% 
  dplyr::mutate(cum_open = cumsum(open)) 

close <- tmp_issues %>% 
  dplyr::filter(flag == "Closed") %>% 
  dplyr::count(close) %>% 
  dplyr::rename(week = close, close = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(close = dplyr::if_else(is.na(close) & week <= max_week, 0L, close)) %>% 
  dplyr::mutate(cum_close = cumsum(close)) 

(open %>% 
  dplyr::full_join(close, by = "week") %>% 
  dplyr::select(week, open = cum_open, closed = cum_close) %>% 
  tidyr::gather(key = "Status", value, -week) %>% 
  dplyr::mutate(Status = as.factor(Status),
                Status = forcats::fct_relevel(Status, "open", "closed")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) + 
    ggplot2::geom_line(ggplot2::aes(y = value, colour = Status)) + 
    ggplot2::labs(y = "", title = "Patch") ) %>% 
  plotly::ggplotly()
```

### Feature
```{r feature_openclose}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::filter(tracker == "Feature") %>% 
  dplyr::mutate(flag = dplyr::if_else(status == "Closed", as.character(status), "Open"),
                open = lubridate::week(open),
                close = lubridate::week(close)) %>% 
  dplyr::select(id, open, close, flag)

# チケット最終週
max_week <- max(tmp_issues$open, tmp_issues$close, na.rm = TRUE)

# チケットオープンの集計
open <- tmp_issues %>% 
  dplyr::count(open) %>% 
  dplyr::rename(week = open, open = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(open = dplyr::if_else(is.na(open) & week <= max_week, 0L, open)) %>% 
  dplyr::mutate(cum_open = cumsum(open)) 

close <- tmp_issues %>% 
  dplyr::filter(flag == "Closed") %>% 
  dplyr::count(close) %>% 
  dplyr::rename(week = close, close = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(close = dplyr::if_else(is.na(close) & week <= max_week, 0L, close)) %>% 
  dplyr::mutate(cum_close = cumsum(close)) 


(open %>% 
  dplyr::full_join(close, by = "week") %>% 
  dplyr::select(week, open = cum_open, closed = cum_close) %>% 
  tidyr::gather(key = "Status", value, -week) %>% 
  dplyr::mutate(Status = as.factor(Status),
                Status = forcats::fct_relevel(Status, "open", "closed")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) + 
    ggplot2::geom_line(ggplot2::aes(y = value, colour = Status)) + 
    ggplot2::labs(y = "", title = "Feature") ) %>% 
  plotly::ggplotly()
```



## Coloumn R {data-width=450} {.tabset}

### Overall
```{r}
issues_2018 %>% 
  dplyr::count(status, priority) %>% 
  tidyr::spread(priority, n) %>% knitr::kable(caption = "All isseues")
  # DT::datatable(caption = "All issues")
```

```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Defect") %>% 
  dplyr::count(status, priority) %>% 
  tidyr::spread(priority, n) %>% knitr::kable(caption = "Defect issues")
  # DT::datatable(caption = "Defect issues")
```

```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Patch") %>% 
  dplyr::count(status, priority) %>% 
  tidyr::spread(priority, n) %>% knitr::kable(caption = "Patch issues")
  # DT::datatable(caption = "Defect issues")
```

```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Feature") %>% 
  dplyr::count(status, priority) %>% 
  tidyr::spread(priority, n) %>% knitr::kable(caption = "Feature issues")
  # DT::datatable(caption = "Defect issues")
```

### Pareto
```{r}
# チケット数の降順の水準を作る
cat_levels <- issues_2018 %>%
  dplyr::count(category) %>%
  dplyr::arrange(dplyr::desc(n)) %>%
  dplyr::mutate(category = as.character(category),
                category = dplyr::if_else(is.na(category), "Uncategorized",
                                          category),
                category = forcats::as_factor(category)) %>%
  with(., levels(category))

# 構成比率データを作る
cum_rate <- issues_2018 %>% 
  dplyr::count(category) %>% 
  dplyr::arrange(dplyr::desc(n)) %>%
  dplyr::mutate(category = as.character(category),
                category = dplyr::if_else(is.na(category), "Uncategorized",
                                          category)) %>%
  dplyr::mutate(cum = cumsum(n), cumrate = round(cum / dplyr::last(cum) * 100, 1))
                
# 積上げ棒グラフを描く
(issues_2018 %>% 
  dplyr::select(tracker, status, category) %>% 
  dplyr::mutate(category = as.character(category),
              category = dplyr::if_else(is.na(category), "Uncategorized",
                                        category)) %>% 
  dplyr::mutate(category = forcats::fct_relevel(category, cat_levels)) %>%
  dplyr::mutate(tracker = forcats::fct_relevel(tracker, "Feature", "Patch")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = category)) + 
    ggplot2::geom_bar(ggplot2::aes(fill = tracker)) +
    ggplot2::geom_path(data = cum_rate,
                       mapping = ggplot2::aes(y = cumrate, group = 1)) +
    ggplot2::scale_y_continuous(sec.axis = ggplot2::sec_axis(~ . / 100,
                                                             name = "累積"),
                                breaks = seq(0L, 100L, 20L)) +
    # ggplot2::scale_x_discrete(breaks = NULL) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    ggplot2::labs(x = "Category", y = "Number of issues") +
    ggplot2::scale_fill_brewer(palette = "Accent")) %>% 
  plotly::ggplotly()
```


### New issues
```{r, echo=FALSE}
issues_2018 %>% 
  dplyr::filter(status == "New") %>% 
  dplyr::select(id, open, tracker, priority, category, subject) %>% 
  DT::datatable(options = list(pageLength = 15))
```


### Staying
```{r, message = FALSE, warning=FALSE}
(issues_2018 %>% 
  dplyr::filter(status != "Closed") %>% 
  dplyr::mutate(days = lubridate::today() - open + 1,
                tracker = forcats::fct_relevel(tracker, "Feature", "Patch")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = days, fill = tracker)) + 
    ggplot2::geom_histogram(alpha = 0.75, position = "identity") +
    # ggplot2::geom_histogram(alpha = 0.6, position = "stack") + 
    ggplot2::labs(x = "滞留日数", y = "", title = "Open issues") + 
    ggplot2::scale_fill_brewer(palette = "Accent")) %>% 
  plotly::ggplotly()
```


# Defect

## Coloumn L {data-width=100}

### Defect
```{r, ref.label="defect_closed"}

```

### New
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Defect" & status == "New") %>% 
  dplyr::count() %>% 
  # flexdashboard::valueBox(caption = "New", color = "danger")
  # Captionを省略した場合は見出しがキャプションとして使われる
  flexdashboard::valueBox(color = "danger", icon = "glyphicon-unchecked")
```

### Reopened
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Defect" & status == "Reopened") %>% 
  dplyr::count() %>% 
  # flexdashboard::valueBox(caption = "Reopened", color = "danger")
  flexdashboard::valueBox(color = "danger", icon = "glyphicon-repeat")
```

### Needs feedback
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Defect" & status == "Needs feedback") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(color = "warning", icon = "glyphicon-earphone")
```

### Confirmed
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Defect" & status == "Confirmed") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(color = "primary", icon = "glyphicon glyphicon-edit")
```

### Resolved
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Defect" & status == "Resolved") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(color = "primary", icon = "glyphicon-log-in")
```

### Closed
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Defect" & status == "Closed") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(color = "success", icon = "glyphicon-check")
```


## Coloumn M {data-width=450} {.tabset}

### Open-Close
```{r, ref.label="defect_openclose"}

```


### Category
```{r}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::filter(tracker == "Defect") %>% 
  dplyr::mutate(open = lubridate::week(open)) %>% 
  dplyr::select(id, status, priority, category, open)

# チケット最終週
max_week <- data.frame(week = c(1:max(tmp_issues$open,
                                      tmp_issues$open, na.rm = TRUE)))

(tmp_issues %>% 
  dplyr::full_join(max_week, ., by = c("week" = "open")) %>% 
  dplyr::mutate(category = as.character(category)) %>%
  tidyr::replace_na(list(category = "Uncategorized")) %>%
  ggplot2::ggplot(ggplot2::aes(x = week)) + 
    ggplot2::geom_bar(ggplot2::aes(fill = category), alpha = 0.75)
) %>% 
  plotly::ggplotly()
```


### Category
```{r}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::filter(tracker == "Defect") %>% 
  dplyr::mutate(open = lubridate::week(open),
                close = lubridate::week(close)) %>% 
  dplyr::select(id, open, close, category)

# チケット最終週
max_week <- data.frame(week = c(1:max(tmp_issues$open,
                                      tmp_issues$close, na.rm = TRUE)))

# 積み上げ面グラフ化（これではNG）
(tmp_issues %>% 
  dplyr::full_join(max_week, ., by = c("week" = "open")) %>% 
  dplyr::count(week, category) %>% 
  tidyr::drop_na(category) %>% 
  tidyr::spread(key = category, value = n) %>% 
  dplyr::mutate_if(is.integer, tidyr::replace_na, 0L) %>% 
  dplyr::mutate_if(is.integer, cumsum) %>%
  tidyr::gather(key = "category", value = "n", -week) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) + 
    ggplot2::geom_area(ggplot2::aes(y = n, fill = category)) +
    ggplot2::labs(x = "Created on [week]", y = "",
                  title = "Category ratio")
) %>% 
  plotly::ggplotly()
```


### Status
```{r}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::filter(tracker == "Defect") %>% 
  dplyr::mutate(open = lubridate::week(open)) %>% 
  dplyr::select(id, status, priority, category, open)

# チケット最終週
max_week <- data.frame(week = c(1:max(tmp_issues$open,
                                      tmp_issues$open, na.rm = TRUE)))

(tmp_issues %>% 
  dplyr::full_join(max_week, ., by = c("week" = "open")) %>% 
  dplyr::mutate(category = as.character(category)) %>%
  tidyr::replace_na(list(category = "Uncategorized")) %>%
  ggplot2::ggplot(ggplot2::aes(x = week)) + 
    ggplot2::geom_bar(ggplot2::aes(fill = status), alpha = 1.0) +
    ggplot2::scale_fill_brewer(palette = "Set3")
) %>% 
  plotly::ggplotly()
```


### Stacked Status
```{r}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::filter(tracker == "Defect") %>% 
  dplyr::mutate(open = lubridate::week(open),
                close = lubridate::week(close)) %>% 
  dplyr::select(id, open, close, status)

# チケット最終週
max_week <- data.frame(week = c(1:max(tmp_issues$open,
                                      tmp_issues$close, na.rm = TRUE)))

# 積み上げ面グラフ化（これではNG）
(tmp_issues %>% 
  dplyr::full_join(max_week, ., by = c("week" = "open")) %>% 
  dplyr::count(week, status) %>% 
  tidyr::drop_na(status) %>% 
  tidyr::spread(key = status, value = n) %>% 
  dplyr::mutate_if(is.integer, tidyr::replace_na, 0L) %>% 
  dplyr::mutate_if(is.integer, cumsum) %>%
  tidyr::gather(key = "status", value = "n", -week) %>% 
  dplyr::mutate(status = forcats::fct_relevel(status, "New", "Reopend",
                                              "Needs feedback", "Confirmed",
                                              "Resolved")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) + 
    ggplot2::geom_area(ggplot2::aes(y = n, fill = status)) +
    # ggplot2::geom_bar(ggplot2::aes(y = n, fill = status), stat = "identity") +
    ggplot2::scale_fill_brewer(palette = "Set3") + 
    ggplot2::labs(x = "Created on [week]", y = "",
                  title = "Status ratio, Not open-close")
) %>% 
  plotly::ggplotly()
```


### Priority
```{r}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::filter(tracker == "Defect") %>% 
  dplyr::mutate(open = lubridate::week(open)) %>% 
  dplyr::select(id, status, priority, category, open)

# チケット最終週
max_week <- data.frame(week = c(1:max(tmp_issues$open,
                                      tmp_issues$open, na.rm = TRUE)))

(tmp_issues %>% 
  dplyr::full_join(max_week, ., by = c("week" = "open")) %>% 
  dplyr::mutate(category = as.character(category)) %>%
  tidyr::replace_na(list(category = "Uncategorized")) %>%
  ggplot2::ggplot(ggplot2::aes(x = week)) + 
    ggplot2::geom_bar(ggplot2::aes(fill = priority), alpha = 0.65) +
    ggplot2::scale_fill_brewer(palette = "Set1")
) %>% 
  plotly::ggplotly()
```


### Stacked Priority
```{r}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::filter(tracker == "Defect") %>% 
  dplyr::mutate(open = lubridate::week(open),
                close = lubridate::week(close)) %>% 
  dplyr::select(id, open, close, priority)

# チケット最終週
max_week <- data.frame(week = c(1:max(tmp_issues$open,
                                      tmp_issues$close, na.rm = TRUE)))

# 積み上げ面グラフ化（これではNG）
(tmp_issues %>% 
  dplyr::full_join(max_week, ., by = c("week" = "open")) %>% 
  dplyr::count(week, priority) %>% 
  tidyr::drop_na(priority) %>% 
  tidyr::spread(key = priority, value = n) %>% 
  dplyr::mutate_if(is.integer, tidyr::replace_na, 0L) %>% 
  dplyr::mutate_if(is.integer, cumsum) %>%
  tidyr::gather(key = "priority", value = "n", -week) %>% 
  dplyr::mutate(priority = forcats::fct_relevel(priority, "Urgent", "High",
                                              "Normal", "Low")) %>%
  ggplot2::ggplot(ggplot2::aes(x = week)) + 
    ggplot2::geom_area(ggplot2::aes(y = n, fill = priority), alpha = 0.65) +
    ggplot2::scale_fill_brewer(palette = "Set1") + 
    ggplot2::labs(x = "Created on [week]", y = "",
                  title = "Priority ratio")
) %>% 
  plotly::ggplotly()
```


### Pareto
```{r}
(issues_2018 %>% 
  dplyr::filter(tracker == "Defect") %>% 
  dplyr::count(category) %>% 
  dplyr::arrange(dplyr::desc(n)) %>% 
  dplyr::mutate(category = as.character(category),
                category = dplyr::if_else(is.na(category), "Uncategorized",
                                          category)) %>%
  dplyr::mutate(cum = cumsum(n), cumrate = round(cum / dplyr::last(cum) * 100, 1),
                category = forcats::as_factor(category)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = category)) + 
    ggplot2::geom_bar(ggplot2::aes(y = n, fill = category), stat = "identity") + 
    ggplot2::scale_y_continuous(sec.axis = ggplot2::sec_axis(~ . / 100,
                                                             name = "累積"),
                                breaks = seq(0L, 100L, 20L)) +
    # ggplot2::scale_x_discrete(breaks = NULL) +
    # ggplot2::theme(axis.text.x = element_blank()) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    ggplot2::geom_path(ggplot2::aes(y = cumrate, group = 1)) +
    ggplot2::labs(x = "Category", y = "Number of issues")) %>% 
  plotly::ggplotly()
```


## Coloumn R {data-width=450}
```{r}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::filter(tracker == "Defect") %>% 
  dplyr::mutate(flag = dplyr::if_else(status == "Closed", as.character(status), "Open"),
                open = lubridate::week(open),
                close = lubridate::week(close)) %>% 
  dplyr::select(id, open, close, flag)

# チケット最終週
max_week <- max(tmp_issues$open, tmp_issues$close, na.rm = TRUE)
```

### Weekly open
```{r}
# チケットオープンの集計
open <- tmp_issues %>% 
  dplyr::count(open) %>% 
  dplyr::rename(week = open, open = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(open = dplyr::if_else(is.na(open) & week <= max_week, 0L, open)) %>% 
  dplyr::mutate(cum_open = cumsum(open), diff = open - dplyr::lag(open)) 

(open %>% 
  dplyr::mutate(diff_offset = diff + round(mean(open, na.rm = TRUE))) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) +
    ggplot2::geom_bar(ggplot2::aes(y = open), stat = "identity", alpha = 0.25) + 
    ggplot2::geom_hline(yintercept = round(mean(open$open, na.rm = TRUE), 1),
                        colour = "#f8766d", linetype = "dashed") + 
    ggplot2::geom_line(ggplot2::aes(y = diff_offset), colour = "#f8766d",
                       size = 0.75)) %>% 
  plotly::ggplotly()
```


### Weekly closed
```{r}
close <- tmp_issues %>% 
  dplyr::filter(flag == "Closed") %>% 
  dplyr::count(close) %>% 
  dplyr::rename(week = close, close = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(close = dplyr::if_else(is.na(close) & week <= max_week, 0L, close)) %>% 
  dplyr::mutate(cum_close = cumsum(close), diff = close - dplyr::lag(close))

(close %>% 
  dplyr::mutate(diff_offset = diff + round(mean(close, na.rm = TRUE)), 1) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) +
    ggplot2::geom_bar(ggplot2::aes(y = close), stat = "identity", alpha = 0.25) + 
    ggplot2::geom_hline(yintercept = round(mean(close$close, na.rm = TRUE)),
                        colour = "#00bfc4", linetype = "dashed") + 
    ggplot2::geom_line(ggplot2::aes(y = diff_offset), colour = "#00bfc4",
                       size = 0.75)) %>% 
  plotly::ggplotly()
```



# Patch
## Coloumn L {data-width=100}

### Patch
```{r, ref.label="patch_closed"}

```

### New
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Patch" & status == "New") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "New", color = "danger")
```

### Reopened
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Patch" & status == "Reopened") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Reopened", color = "danger")
```

### Needs feedback
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Patch" & status == "Needs feedback") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Needs feedback", color = "warning")
```

### Confirmed
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Patch" & status == "Confirmed") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Confirmed", color = "primary")
```

### Resolved
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Patch" & status == "Resolved") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Resolved", color = "primary")
```

### Closed
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Patch" & status == "Closed") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Closed", color = "success")
```

## Coloumn M {data-width=450} {.tabset}

### Open-Close
```{r, ref.label="patch_openclose"}

```

### Pareto
```{r}
(issues_2018 %>% 
  dplyr::filter(tracker == "Patch") %>% 
  dplyr::count(category) %>% 
  dplyr::arrange(dplyr::desc(n)) %>% 
  dplyr::mutate(category = as.character(category),
                category = dplyr::if_else(is.na(category), "Uncategorized",
                                          category)) %>%
  dplyr::mutate(cum = cumsum(n), cumrate = round(cum / dplyr::last(cum) * 100, 1),
                category = forcats::as_factor(category)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = category)) + 
    ggplot2::geom_bar(ggplot2::aes(y = n, fill = category), stat = "identity") + 
    ggplot2::scale_y_continuous(sec.axis = ggplot2::sec_axis(~ . / 100,
                                                             name = "累積"),
                                breaks = seq(0L, 100L, 20L)) +
    # ggplot2::scale_x_discrete(breaks = NULL) +
    # ggplot2::theme(axis.text.x = element_blank()) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    ggplot2::geom_path(ggplot2::aes(y = cumrate, group = 1)) +
    ggplot2::labs(x = "Category", y = "Number of issues")) %>% 
  plotly::ggplotly()
```

## Coloumn R {data-width=450}
```{r}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::filter(tracker == "Patch") %>% 
  dplyr::mutate(flag = dplyr::if_else(status == "Closed", as.character(status), "Open"),
                open = lubridate::week(open),
                close = lubridate::week(close)) %>% 
  dplyr::select(id, open, close, flag)

# チケット最終週
max_week <- max(tmp_issues$open, tmp_issues$close, na.rm = TRUE)
```


### Weekly open
```{r}
# チケットオープンの集計
open <- tmp_issues %>% 
  dplyr::count(open) %>% 
  dplyr::rename(week = open, open = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(open = dplyr::if_else(is.na(open) & week <= max_week, 0L, open)) %>% 
  dplyr::mutate(cum_open = cumsum(open), diff = open - dplyr::lag(open)) 

(open %>% 
  dplyr::mutate(diff_offset = diff + round(mean(open, na.rm = TRUE))) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) +
    ggplot2::geom_bar(ggplot2::aes(y = open), stat = "identity", alpha = 0.25) + 
    ggplot2::geom_hline(yintercept = round(mean(open$open, na.rm = TRUE), 1),
                        colour = "#f8766d", linetype = "dashed") + 
    ggplot2::geom_line(ggplot2::aes(y = diff_offset), colour = "#f8766d",
                       size = 0.75)) %>% 
  plotly::ggplotly()
```


### Weekly closed
```{r}
close <- tmp_issues %>% 
  dplyr::filter(flag == "Closed") %>% 
  dplyr::count(close) %>% 
  dplyr::rename(week = close, close = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(close = dplyr::if_else(is.na(close) & week <= max_week, 0L, close)) %>% 
  dplyr::mutate(cum_close = cumsum(close), diff = close - dplyr::lag(close))

(close %>% 
  dplyr::mutate(diff_offset = diff + round(mean(close, na.rm = TRUE)), 1) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) +
    ggplot2::geom_bar(ggplot2::aes(y = close), stat = "identity", alpha = 0.25) + 
    ggplot2::geom_hline(yintercept = round(mean(close$close, na.rm = TRUE)),
                        colour = "#00bfc4", linetype = "dashed") + 
    ggplot2::geom_line(ggplot2::aes(y = diff_offset), colour = "#00bfc4",
                       size = 0.75)) %>% 
  plotly::ggplotly()
```



# Feature

## Coloumn L {data-width=100}

### Feature
```{r, ref.label="feature_closed"}

```

### New
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Feature" & status == "New") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "New", color = "danger")
```

### Reopened
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Feature" & status == "Reopened") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Reopened", color = "danger")
```

### Needs feedback
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Feature" & status == "Needs feedback") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Needs feedback", color = "warning")
```

### Confirmed
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Feature" & status == "Confirmed") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Confirmed", color = "primary")
```

### Resolved
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Feature" & status == "Resolved") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Resolved", color = "primary")
```

### Closed
```{r}
issues_2018 %>% 
  dplyr::filter(tracker == "Feature" & status == "Closed") %>% 
  dplyr::count() %>% 
  flexdashboard::valueBox(caption = "Closed", color = "success")
```

## Coloumn M {data-width=450} {.tabset}

### Open-Close
```{r, ref.label="feature_openclose"}

```

### Pareto
```{r}
(issues_2018 %>% 
  dplyr::filter(tracker == "Feature") %>% 
  dplyr::count(category) %>% 
  dplyr::arrange(dplyr::desc(n)) %>% 
  dplyr::mutate(category = as.character(category),
                category = dplyr::if_else(is.na(category), "Uncategorized",
                                          category)) %>%
  dplyr::mutate(cum = cumsum(n), cumrate = round(cum / dplyr::last(cum) * 100, 1),
                category = forcats::as_factor(category)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = category)) + 
    ggplot2::geom_bar(ggplot2::aes(y = n, fill = category), stat = "identity") + 
    ggplot2::scale_y_continuous(sec.axis = ggplot2::sec_axis(~ . / 100,
                                                             name = "累積"),
                                breaks = seq(0L, 100L, 20L)) +
    # ggplot2::scale_x_discrete(breaks = NULL) +
    # ggplot2::theme(axis.text.x = element_blank()) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    ggplot2::geom_path(ggplot2::aes(y = cumrate, group = 1)) +
    ggplot2::labs(x = "Category", y = "Number of issues")) %>% 
  plotly::ggplotly()
```


## Coloumn R {data-width=450}
```{r}
# 対象チケットの洗い出し
tmp_issues <- issues_2018 %>% 
  dplyr::filter(tracker == "Feature") %>% 
  dplyr::mutate(flag = dplyr::if_else(status == "Closed", as.character(status), "Open"),
                open = lubridate::week(open),
                close = lubridate::week(close)) %>% 
  dplyr::select(id, open, close, flag)

# チケット最終週
max_week <- max(tmp_issues$open, tmp_issues$close, na.rm = TRUE)
```


### Weekly open
```{r}
# チケットオープンの集計
open <- tmp_issues %>% 
  dplyr::count(open) %>% 
  dplyr::rename(week = open, open = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(open = dplyr::if_else(is.na(open) & week <= max_week, 0L, open)) %>% 
  dplyr::mutate(cum_open = cumsum(open), diff = open - dplyr::lag(open)) 

(open %>% 
  dplyr::mutate(diff_offset = diff + round(mean(open, na.rm = TRUE))) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) +
    ggplot2::geom_bar(ggplot2::aes(y = open), stat = "identity", alpha = 0.25) + 
    ggplot2::geom_hline(yintercept = round(mean(open$open, na.rm = TRUE), 1),
                        colour = "#f8766d", linetype = "dashed") + 
    ggplot2::geom_line(ggplot2::aes(y = diff_offset), colour = "#f8766d",
                       size = 0.75)) %>% 
  plotly::ggplotly()
```


### Weekly closed
```{r}
close <- tmp_issues %>% 
  dplyr::filter(flag == "Closed") %>% 
  dplyr::count(close) %>% 
  dplyr::rename(week = close, close = n) %>% 
  dplyr::full_join(weeks, .,by = "week") %>% 
  dplyr::mutate(close = dplyr::if_else(is.na(close) & week <= max_week, 0L, close)) %>% 
  dplyr::mutate(cum_close = cumsum(close), diff = close - dplyr::lag(close))

(close %>% 
  dplyr::mutate(diff_offset = diff + round(mean(close, na.rm = TRUE)), 1) %>% 
  ggplot2::ggplot(ggplot2::aes(x = week)) +
    ggplot2::geom_bar(ggplot2::aes(y = close), stat = "identity", alpha = 0.25) + 
    ggplot2::geom_hline(yintercept = round(mean(close$close, na.rm = TRUE)),
                        colour = "#00bfc4", linetype = "dashed") + 
    ggplot2::geom_line(ggplot2::aes(y = diff_offset), colour = "#00bfc4",
                       size = 0.75)) %>% 
  plotly::ggplotly()
```



# Life-Work Balance

## Coloumn L {data-width=500}

### Open at
```{r}
(issues_2018 %>% 
  dplyr::select(tracker, category, open_h) %>% 
  dplyr::mutate(tracker = forcats::fct_relevel(tracker, "Feature", "Patch")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = open_h)) + 
    ggplot2::geom_bar(ggplot2::aes(fill = tracker)) + 
    ggplot2::labs(x = "Open hour [H]", y = "Number of issues") +
    ggplot2::scale_fill_brewer(palette = "Accent")) %>% 
  plotly::ggplotly()
```

### Update at
```{r}
(issues_2018 %>% 
  dplyr::select(tracker, category, update_h) %>% 
  dplyr::mutate(tracker = forcats::fct_relevel(tracker, "Feature", "Patch")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = update_h)) + 
    ggplot2::geom_bar(ggplot2::aes(fill = tracker)) + 
    ggplot2::labs(x = "Update hour [H]", y = "Number of issues") +
    ggplot2::scale_fill_brewer(palette = "Accent")) %>% 
  plotly::ggplotly()
```

### Close at
```{r}
(issues_2018 %>% 
  dplyr::select(tracker, category, close_h) %>% 
  dplyr::mutate(tracker = forcats::fct_relevel(tracker, "Feature", "Patch")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = close_h)) + 
    ggplot2::geom_bar(ggplot2::aes(fill = tracker)) + 
    ggplot2::labs(x = "Close hour [H]", y = "Number of issues") +
    ggplot2::scale_fill_brewer(palette = "Accent")) %>% 
  plotly::ggplotly()
```


## Coloumn R {data-width=500} {.tabset}

### Ranking
　  
**Bussiness Hours : 9 to 18**
　  

```{r, include=FALSE}
open_at <- 9
close_at <- 18
```

```{r}
issues_2018 %>% 
  dplyr::filter(open_h > close_at | open_h < open_at) %>% 
  dplyr::count(author) %>% 
  dplyr::arrange(dplyr::desc(n)) %>% 
  dplyr::top_n(3) %>% knitr::kable(caption = "Open at extra hours, Worst 3")

issues_2018 %>% 
  dplyr::filter(update_h > close_at | update_h < open_at) %>% 
  dplyr::count(author) %>% 
  dplyr::arrange(dplyr::desc(n)) %>% 
  dplyr::top_n(3) %>% knitr::kable(caption = "Update at extra hours, Worst 3")

issues_2018 %>% 
  dplyr::filter(close_h > close_at | close_h < open_at) %>% 
  dplyr::count(assigned_to) %>% 
  dplyr::arrange(dplyr::desc(n)) %>% 
  dplyr::top_n(3) %>% knitr::kable(caption = "Close at extra hours, Worst 3")
```

### Open
```{r}
issues_2018 %>% 
  dplyr::filter(open_h > close_at | open_h < open_at) %>% 
  dplyr::select(id, created_on, tracker, category, author, subject) %>% 
  DT::datatable(options = list(pageLength = 10))
```

### Update
```{r}
issues_2018 %>% 
  dplyr::filter(update_h > close_at | update_h < open_at) %>% 
  dplyr::select(id, created_on, tracker, category, author, subject) %>% 
  DT::datatable(options = list(pageLength = 10))
```

### Close
```{r}
issues_2018 %>% 
  dplyr::filter(close_h > open_at | close_h < close_at) %>% 
  dplyr::select(id, closed_on, tracker, category, assigned_to, subject) %>% 
  DT::datatable(options = list(pageLength = 10))
```



# Bubble

## Coloumn L {data-width=500}

### Priority
```{r}
(issues_2018 %>% 
  dplyr::select(open_h, close_h, priority) %>% 
  tidyr::drop_na(close_h) %>% 
  dplyr::count(open_h, close_h, priority) %>% 
  ggplot2::ggplot(ggplot2::aes(x = open_h, y = close_h)) + 
    ggplot2::geom_point(ggplot2::aes(colour = priority, size = n)) +
    ggplot2::labs(x = "Open at", y = "Close at")
) %>% 
  plotly::ggplotly()
```

## Coloumn R {data-width=500}

### Category
```{r}
(issues_2018 %>% 
  dplyr::select(open_h, close_h, category) %>% 
  tidyr::drop_na(close_h) %>% 
  dplyr::count(open_h, close_h, category) %>% 
  ggplot2::ggplot(ggplot2::aes(x = open_h, y = close_h)) + 
    ggplot2::geom_point(ggplot2::aes(colour = category, size = n)) +
    ggplot2::labs(x = "Open at", y = "Close at")
) %>% 
  plotly::ggplotly()
```




# skimr

## Coloumn {data-width=1000}

### Overall
```{r}
issues_2018 %>% 
  skimr::skim_to_wide() %>% knitr::kable()
```




# Category List
```{r}
issues_2018 %>% 
  dplyr::select(category, sub_category) %>% 
  dplyr::distinct() %>% 
  tidyr::drop_na() %>% 
  dplyr::arrange(category, sub_category) %>% 
  DT::datatable(options = list(pageLength = 15))
```

