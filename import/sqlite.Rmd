---
title: "SQLite"
output: 
  html_document:  
    code_folding: show
    css: style.css
---

<!-- shared Links -->
```{r index, child="../shared/links.Rmd", include=FALSE}
```

```{r setup, message=FALSE, warning=FALSE, error=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

require(RSQLite)
require(stringi)
require(tidyverse)
```

SQLiteはMySQLやPostgreSQLなどのクライアント・サーバ型のDBMSとは異なりデータベース・ファイルを直接読み書きする軽量なデータベース・システム（以降、DBMS）です。初めてDBMSを利用する場合や小規模DBMSに向いています。SQLiteは複数のパッケージがサポートしていますが`RSQLite`パッケージを利用するのが最もベーシックです。  
　  

なお、本ページでは`r R.version$version.string`の標準パッケージ以外に以下の追加パッケージを用いています。  
　  

Package   | Version |Description
----------|---------|----------------------------------------------------------
tidyverse | `r packageVersion('tidyverse')` | Easily Install and Load the ‘Tidyverse’
RSQLite   | `r packageVersion('RSQLite')` | 'SQLite' Interface for R
stringi   | `r packageVersion('stringi')` | Character String Processing Facilities

　  

また、本ページでは以下のデータセットを用いています。  
　  

Dataset    | Package  | Version | Description
-----------|----------|---------|----------------------------------------------
airquality | datasets | `r packageVersion('datasets')`| New York Air Quality Measurements
redmine    | N/A      | N/A     | [Redmine Issues <i class="fa fa-external-link"></i>](http://www.redmine.org/projects/redmine/issues){target="_blank" title="redmine.org"}

　  

# RSQLite
`RSQLite`パッケージは`DBI`パッケージに準拠したインタフェースを提供してくれるSQLite専用のパッケージです。SQL文を利用したDBMS操作が可能になります。
　  

```{r}

# 以下の指定では日時のタイムゾーンはロケールにしたがうハズ。タイムゾーンを
# 明示的に指定するには`readr::parse_datetime`関数で明示的に指定する。
col_type <- list(readr::col_integer(), readr::col_character(),
                 readr::col_character(), readr::col_character(),
                 readr::col_character(), readr::col_character(),
                 readr::col_character(), readr::col_character(),
                 readr::col_character(), readr::col_datetime(format = ""),
                 readr::col_character(), readr::col_character(),
                 readr::col_date(), readr::col_date(), readr::col_double(),
                 readr::col_double(), readr::col_datetime(format = ""),
                 readr::col_datetime(format = ""), readr::col_character(),
                 readr::col_character(), readr::col_character(),
                 readr::col_character())

redmine <- "./data/" %>% 
  list.files(path = ., pattern = "(issues_)", full.names = TRUE) %>% 
  lapply(X = ., FUN = readr::read_csv,
         locale = readr::locale(encoding = "cp932"), col_types = col_type) %>% 
  do.call(what = dplyr::bind_rows, args = .) %>%
  dplyr::distinct() %>% 
  dplyr::rename(id = `#`, project = `プロジェクト`, tracker = `トラッカー`,
                parent = `親チケット`, status = `ステータス`,
                priority = `優先度`, subject = `題名`, auther = `作成者`,
                assignee = `担当者`, update = `更新日`, category = `カテゴリ`,
                version = `対象バージョン`, start = `開始日`, limit = `期日`,
                estimate = `予定工数`, progress = `進捗率`, open = `作成日`,
                close = `終了日`, related = `関連するチケット`,
                resolution = `Resolution`, affected = `Affected version`,
                memo = `説明`)
```


```{r, eval=FALSE}
con <- RSQLite::dbConnect(RSQLite::SQLite(), "./data/sqlite.db")

RSQLite::dbListTables(con)

# 以下のコマンドでは日付（POSIXct）が数値型（double）になってしまうが
# UNIX時間で保存されていて`lubridate::as_datetime`関数でPOSIXct形式に
# 変換できる
RSQLite::dbWriteTable(con, "redmine", as.data.frame(redmine))

# ただし、なぜかデフォルトロケールではUTC
readr::default_locale()
readr::locale(tz = "Japan")

RSQLite::dbListTables(con)

# フィールド名には日本語を使わない
RSQLite::dbListFields(con, "redmine")

# 
redmine_sql <- RSQLite::dbReadTable(con, "redmine")

lubridate::as_datetime(redmine$open, tz = default_locale()) %>% head()

# 日時のタイムゾーンはUTCなので必要に応じてタイムゾーンを指定する
lubridate::as_datetime(redmine_sql$open, tz = "Japan") %>% head()

RSQLite::dbDisconnect(con)
```

　  

# 参考資料
* [RからSQLiteを使う <i class="fa fa-external-link"></i>](https://oku.edu.mie-u.ac.jp/~okumura/stat/sqlite.html){target="_blank" title=""}
* [RSQLite の使い方 (1) <i class="fa fa-external-link"></i>](http://www.singularpoint.org/blog/r/r-tips-rsqlite-1/){target="_blank" title="singular point"}
* [RSQLite の使い方 (2) <i class="fa fa-external-link"></i>](http://www.singularpoint.org/blog/r/r-tips-rsqlite-2/){target="_blank" title="singular point"}
* [RSQLite パッケージ  <i class="fa fa-external-link"></i>](https://www.kunihikokaneko.com/free/r/rsqlite.html){target="_blank" title=""}

---

<!-- Footer -->
```{r child="../shared/footer.Rmd"}
```