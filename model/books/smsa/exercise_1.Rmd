---
title: "第1章 演習解答例"
output: 
  html_document:  
    number_section: no
---

<!-- Include Common Links -->
```{r exercise_1, child="../../../common/links.Rmd"}
```

```{r setup, include=FALSE}
# 共通chunkオプションの指定
knitr::opts_chunk$set(warning = FALSE, echo = TRUE)

# データハンドリングで利用するパッケージの読み込み
require(tidyverse)

# 表示で利用する外部パッケージの読み込み
require(gridExtra)
require(DT)
require(knitr)
require(extrafont)

# モデリングで利用するパッケージの読み込み
require(psych)

# コンフリクトの解消
tidyverse::tidyverse_conflicts()

# 共通ローカル関数の読み込み
source("../../../common/common.R")
```

# はじめに
本資料は『[ソフトウェアメトリクス統計分析入門][5]』(以降、テキストと記載)の第1章の演習問題を[R][R]で解いた際の解答例を示したものです。また、[R Markdown][RM]を使うメリットを示すための一手段として作成していますので、テキストにおける計算方法とは異なる部分もあります。本資料で使用しているデータの入手に関してはテキストにてご確認下さい。  
本資料がHTML形式の場合、Rのコードを参照するには右側にある**`[Code]`**ボタンをクリックして下さい。なお、JavaScriptは必ずOnにしてご覧下さい。  
  

# 演習問題
> 第1章は全ての問題で「第1章_例題演習データ」ファイルの「1章演習データ」シートにあるデータを使用します。このシートにはある架空の組織のプロジェクトごとの生産性(行/人月)と工数予実割合(実績総工数/見積総工数)のデータが55プロジェクト分あります。
> 
> * $\mbox{プロジェクト名}(prj)$
> * $\mbox{生産性}(prod) = \frac{\mbox{新規開発行数(行)}}{\mbox{総開発工数(人月)}}$
> * $\mbox{工数予実割合}(rate) = \frac{\mbox{実績総工数(人月)}}{\mbox{見積総工数(人月)}}$
  
演習データは予めRで読み込めるCSVファイルに加工してあるものとし、これを読み込み、読み込んだ中身を確認します。
```{r, include=FALSE}
file <- "./data/ex1_data.csv"
x <- read.csv(file, header = TRUE, sep = ",", fileEncoding = "CP932")
colnames(x) <- c("prj", "prod", "rate")
df_print(x)
```


# 演習1.1
> 例題1.2 の考え方を適用して、「第1章演習データ」の生産性の上限、下限の基準値を設定してください。設定のための条件は以下のとおりとします。	
>
> * 基準の下限を外れたプロジェクトは、なぜそのように低くなってしまったかの原因究明を行い、次のプロジェクトで改善をする目的で下限の基準値を活用します。
> * 下位10％ぐらいが対象となるように下限の基準値を設定します。
> * 基準の上限を外れたプロジェクトは、ベストプラクティスとして理由を探り、他のプロジェクトへの水平展開を行う目的で上限の基準値を活用します。
> * 上位5％ぐらいが対象となるように上限の基準値を設定します。
> * 各基準値を決める前にデータ分布の確認を行い、そこで外れ値とみなされたデータは除去します。	

## データ分布の確認 {.tabset}

### histgram  {.unnumbered}
```{r, fig.cap="生産性のヒストグラム"}
hist(x$prod, main = "", xlab = "生産性")
```

生産性データのヒストグラムを描いて見ると左側の大きな山と右側の小さな丘に分かれていることが分かります。このことから右側の小さな丘のデータは外れ値の可能性があるので、箱ひげ図にて確認します。

***

### boxplot  {.unnumbered}
```{r, fig.cap="生産性の箱ひげ図"}
boxplot(x$prod)
```

箱ひげ図を描いて見るとヒストグラムで右側にあったデータ(`r boxplot(x$prod)$out`)は外れ値と判断できますので、分析対象データとしてこれらを削除してから分析を行うことにします。

***

### 外れ値の削除  {.unnumbered}
箱ひげ図のヒンジ(ひげ)を超える値を外れ値とします。なお、箱ひげ図のヒンジは五数要約にて算出可能です。

```{r}
# ヒンジ内のデータを抜き出す
x.removed <- subset(x, (prod >= boxplot.stats(x$prod)$stats[1]) & 
                       (prod <= boxplot.stats(x$prod)$stats[5]))
df_print(x.removed)
```

***

## データ分布の再確認  {.tabset}
以下のタブは`.tabset-fade`と`.tabset-pills`を指定指定しています。

### histrgam {.unnumbered}
```{r, fig.cap="外れ値を除いた生産性のヒストグラム"}
hist(x.removed$prod, main = "", xlab = "生産性")
```

***

### boxplot {.unnumbered}
```{r, fig.cap="外れ値を除いた生産性の箱ひげ図"}
boxplot(x.removed$prod)
```

外れ値を削除した後の生産性データのヒストグラムならびに箱ひげ図を見ると概ね正規分布に近い分布をなしているように見えます。念のためにQQプロットと正規性の検定により正規分布と言えるかどうかを確認しておきます。

***

### 正規性の確認 {.unnumbered}
```{r}
# QQプロット(RcmdrのQQプロットを使うのが簡単)
with(x.removed, car::qqPlot(prod, dist = "norm", id.method = "y", id.n = 2,
                            labels = rownames(x.removed)))
# 正規性の検定(帰無仮説H0は「分布が正規分布に從う」である)
shapiro.test(x.removed$prod)
```

QQプロットのグラフ形状を見ると左下で若干、直線から外れ気味のデータがあるものの概ね正規分布にしたがっていると見ることができます。一方、正規性の検定の結果を見ると**p = `r shapiro.test(x.removed$prod)$p.value`**であり帰無仮説は棄却されませんでしたので、正規分布にしたがっていないとは言い切れません。

***

## 標準値の算出
外れ値を除いたデータは前述の通り概ね正規分布にしたがっているといえますのでこれを用いて平均値と標準偏差から基準値を求めます。上限、下限は設問にあるとおり5\%ならびに10\%とします。

```{r}
# 平均値と標準偏差の算出
x.removed.mean <- mean(x.removed$prod, na.rm = TRUE)
x.removed.sd <- sd(x.removed$prod, na.rm = TRUE)
# 上限基準値の算出
upper <- qnorm(0.05, mean = x.removed.mean, sd = x.removed.sd,
               lower.tail = FALSE)
# 下限基準値の算出
lower <- qnorm(0.1, mean = x.removed.mean, sd = x.removed.sd,
               lower.tail = TRUE)
```

計算の結果、基準値の上限値は$`r round(upper)`$で下限値は$`r round(lower)`$と
なりました。  


# 演習1.2
> 演習1.1 で外れ値を除去した生産性データを使って、この組織で生産性が300(行/人月)のプロジェクトは下位何\％に相当するかを算出してください。  
> 併せて偏差値も算出してください。

## 計算
演習1.1において生産性データは概ね正規分布にしたがっていると判断していますので、生産性が300(行/人)の確率は正規分布の確率密度関数を用いて算出します。
```{r}
# 下位側から確率の計算
result.300 <- pnorm(300, mean = x.removed.mean, sd = x.removed.sd,
                    lower.tail = TRUE)
```

一方、偏差値は上記にて確率を算出していますので平均値50、標準偏差10の正規分布から求めることが可能です。
```{r}
# 偏差値(standard score)を出す場合は平均値50、標準偏差10の正規分布の確率から
# 逆算すればよい
ss <- qnorm(result.300, mean = 50, sd = 10, lower.tail = TRUE)
```

計算の結果、生産性が300行/人月のプロジェクトは下位$`r round(result.300 * 100)`\%$に相当し、その偏差値は$`r round(ss)`$です。


# 演習1.3
> 演習1.1 の生産性の上限、下限の基準値を以下で解説するパーセンタイルを用いた方法で算出してください。条件は演習1.1と同じとします。
> 
> パーセンタイルとは、本文中の表1.1で説明しているP25やP75のようにデータ全体のうちデータを昇順に並べて、指定したパーセンテージの位置にあるデータを示します。
> 本文中にも書いたとおり、P25は25パーセンタイルといいます。

<!-- Excel 関数はPERCENTILEです。使い方は、以下のとおりです．
PERCENTILE（データ範囲, 指定するパーセンテージ） -->

## 計算
Rにおけるパーセンタイル計算には`quantile {stats}`を利用します。
```{r}
round(quantile(x.removed$prod, probs = c(0.1, 0.95), na.rm = TRUE))
```

引数`probs`で計算したいパーセンタイル点を指定することで任意のパーセンタイルが計算できます。`probs`の指定を省略した場合はデフォルト値として四分位値(0\%, 25\%, 50\%, 75\%, 100\%)が計算されます。


# 演習1.4
> 生産性に加えて、工数予実割合も加味してプロジェクトの評価をしようと考えています。以下の条件、方法に従い、各プロジェクトをA～Eの5段階で評価してください。  
>   
> * 生産性は高いほど良い、工数予実割合は低いほど良いとします。
> * 手順は以下のとおりとします。
> 
> 1. 生産性のデータ分布確認は省略し、平均と標準偏差も演習1.1の結果のとおりとする。
> 1. 工数予実割合はデータ分布の確認を行い、必要ならば外れ値とみなされたデータを除去する。
> 1. 工数予実割合の平均と標準偏差を算出する。
> 1. 各プロジェクトの生産性のZスコアを算出する。
> 1. 各プロジェクトの工数予実割合のZスコアを算出する	
>    （ただし、工数予実割合は低いほど良いので符号を逆転させる）。
> 1. 各プロジェクトの生産性、工数予実割合のZスコアの平均を算出する。
>    欠損値がある場合は、片方のZスコアの値とする。
> 1. 上記で求めたZ スコア平均を以下のとおりA～Eの評価に換算する。
>     + Zスコアが、-0.5～0.5は中間の評価でC。
>     + Zスコアが、0.5～1.5はB、-1.5～-0.5 はD。	
>     + Zスコアが、1.5超えるものはA、-1.5を下回るものはE。	


## データ分布の確認 {.tabset}
### histogram {.unnumbered}
```{r}
hist(x.removed$rate, main = "", xlab = "工数予実割合")
```

***

### boxplot {.unnumbered}
```{r}
boxplot(x.removed$rate)
```

***

### qqplot {.unnumbered .tabset} 
```{r}
# QQプロット
with(x.removed, car::qqPlot(rate, dist = "norm", id.method = "y", id.n = 2,
                            labels = rownames(x.removed)))
```

#### 正規性の検定 {.unnumbered}
```{r}
# 正規性の検定(帰無仮説H0は「分布が正規分布に從う」である)
shapiro.test(x.removed$rate)
```

***

#### 確認の結果 {.unnumbered}
ヒストグラムならびに箱ひげ図を見ると若干、左に歪んだ分布ですが概ね正規分布にしたがっているように見えます。  
QQプロットのグラフ形状では、中心付近のデータがやや外れ気味位見えますが、概ね正規分布にしたがっているように見えます。  
一方、正規性の検定の結果を見ると$p = `r shapiro.test(x.removed$rate)$p.value`$であり帰無仮説が棄却されていますが、今回は正規分布にしたがうと見なすことにします。

***

## Zスコアと結果の計算と表示
```{r}
# データ全体を計算する方法
# 生産性のみ演習1.1で計算した外れ値を除いた平均値と標準偏差で計算する
x$z.prod <- round(scale(x$prod, center = x.removed.mean, scale = x.removed.sd),
                  digits = 2)
x$z.rate <- round(-scale(x$rate), digits = 2)

# Zスコア平均値の算出
x$z <- round(apply(x[c("z.prod", "z.rate")], MARGIN = 1, FUN = mean,
                   na.rm = TRUE), digits = 2)
# 判定結果の作成
z <- x$z
x$eval <- ifelse(z > 1.5, "A",
                 ifelse(z > 0.5, "B",
                        ifelse(z > -0.5, "C",
                               ifelse(z > -1.5, "D", "E"))))
# 偏差値の算出
x$ss <- round(x$z * 10 +50)
# 結果の表示
colnames(x) <- c("プロジェクト名", "生産性", "工数予実割合", "Z値(生産性)",
                 "Z値(工数予実割合)", "Z値", "評価", "偏差値")
df_print(x)
colnames(x) <- c("prj", "prod", "rate", "z.prod", "z.rate", "z", "eval", "ss")
```


<!-- ## `formattable`パッケージによるカラフルな表現 -->
<!-- `formattable`パッケージは残念ながら日本語が文字化けし、HTML以外では装飾が再現され -->
<!-- ませんので、結果が出力されるのはHTMLドキュメントのみになるように設定しています。 -->
<!-- また、NAが含まれているとエラーになります。 -->

<!-- ```{r formmatable package, message=FALSE} -->
<!-- require(formattable) -->

<!-- # df <- x.removed -->
<!-- df <- x -->
<!-- colnames(df) <- c("project", "perf", "pp.ratio", "z.perf", "z.pp.ratio", -->
<!--                   "z.score", "rank", "score") -->

<!-- formattable(df, list( -->
<!--   z.score = color_bar("pink", 0.2), -->
<!--   rank = formatter("span", -->
<!--                    style = x ~ ifelse(x == "A", style(color = "red", -->
<!--                                                       font.weight = "bold"), -->
<!--                                       ifelse(x == "B", style(color = "red"), -->
<!--                                              ifelse(x == "E", -->
<!--                                                     style(color = "lightgreen"), -->
<!--                                                     NA)))), -->
<!--   score = color_tile("white", "orange") -->
<!-- )) -->
<!-- ``` -->


# 演習1.4別解
ランク分けが簡単にできる`cut {base}`を利用した解答例です。

```{r}
# RでZスコアを計算するには`scale {base}`を使うと簡単
# 生産性は外れ値を除いて計算した平均値と標準偏差でZスコアを計算
x$z.prod <- round(scale(x$prod, center = x.removed.mean, scale = x.removed.sd),
                  digits = 2)
# 工数予実割合は外れ値を除かないで計算した平均値と標準偏差でZスコアを計算
x$z.rate <- round(-scale(x$rate), digits = 2)

# 念の為にZスコアを計算する際に使用された平均値と標準偏差を確認しておく
# 生産性
print(paste("生産性 平均値:", round(attributes(x$z.prod)$`scaled:center`),
            " 標準偏差:", round(attributes(x$z.prod)$`scaled:scale`)))
# 工数予実割合
print(paste("工数予実割合 平均値:", round(attributes(x$z.rate)$`scaled:center`,
                                          digits = 2),
            " 標準偏差:", round(attributes(x$z.rate)$`scaled:scale`,
                                digits = 2)))

# Zスコア平均値の算出
x$z <- round(apply(x[c("z.prod", "z.rate")], MARGIN = 1, FUN = mean,
                   na.rm = TRUE), digits = 2)

# 判定結果の作成
# 区分が変わることを考えるとはcut {base}を利用して区間分割&因子変換するの方が
# 管理しやすいのでおぼえておくと便利
breaks <- c(-Inf, -1.5, -0.5, 0.5, 1.5, Inf)
levels <- c("E", "D", "C", "B", "A")        # 因子の順番に注意
x$eval <- cut(x$z, breaks = breaks, labels = levels)
# 偏差値の算出
x$ss <- round(x$z * 10 + 50)
# 結果の表示
x.colname <- colnames(x)
colnames(x) <- c("プロジェクト名", "生産性", "工数予実割合", "Z値(生産性)",
                "Z値(工数予実割合)", "Z値", "評価", "偏差値")
df_print(x)
colnames(x) <- x.colname
```

## おまけの可視化
層別による生産性と工数予実割合の関係を可視化してみただけなので、予測に使えるとかいう意味や意図は全くないですが、グラフを見て分かるように評価の良いプロジェクトは値が良い方に外れており、評価の悪いプロジェクトは値の悪い方に外れていることからが図からも分かります。

```{r}
# 層別で散布図を描く
car::scatterplot(rate ~ prod | eval, reg.line = lm, smooth = FALSE,
                 spread = FALSE, id.method = 'mahal', id.n = 2, boxplots = 'xy',
                 span = 0.5, by.groups = TRUE, data = x)
# 評価毎の相関係数を求める(無相関検定の帰無仮説は「相関係数が零である」)
for (i in sort(levels(x$eval))) {
  if (with(x, length(na.omit(rate[eval==i]))) > 1) {
    result <- with(na.omit(x), cor.test(rate[eval==i], prod[eval==i],
                                        alternative = "two.sided",
                                        method = "pearson"))
    if (result$p.value < 0.05){
      print(paste("評価:", i, " 相関係数:", round(result$estimate, digits = 2),
                  " p値:", result$p.value, sep = ""))
    } else {
      print(paste("評価:", i, " 帰無仮説が棄却されませんでした p値:",
                  round(result$p.value, digits = 2), sep = ""))
    }
  } else {
    print(paste("評価:", i, " データ不足で相関係数が計算できませんでした",
                sep = ""))
  }
}
```

---

<!-- Include Footer -->
```{r child="../../../common/footer.Rmd"}
```
