---
output:
  html_document:
    code_folding: show
    css: style.css
---

```{r histgram, child="../shared/links.Rmd", include=FALSE}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(tidyverse)
require(gridExtra)
require(DT)
require(knitr)

tidyverse::tidyverse_conflicts()

class <- c("display cell-border compact")
style <- ifelse(!interactive(), c("bootstrap"), c("default"))
```

# ヒストグラム
[R <i class="fa fa-external-link"></i>][R]でヒストグラムを描く代表的な方法としては、以下の二つの方法があります。  
　  

* **`hist`**関数を用いる
* **`ggplot2::geom_histogram`**関数を用いる

　  
**`ggplot2`**パッケージは統一感のあるコード記述で統一感のある体裁のグラフが描けますのでこちらを利用することをおすゝめします。ただ、基本パッケージのひとつである**`graphics`**パッケージに含まれる**`hist`**関数は描いたデータに対する各種計算値が簡単に得られるというメリットがありますので必要に応じて使い分けてください。  
　  

# 二つの関数の違い
**`hist`**関数と**`ggplot2::geom_histgram`**関数はデフォルト・オプションでヒストグラムを描いた場合に処理の考え方の違いにより異なる形状のヒストグラムになる場合があります。その違いを知るために組み込みデータセット**`mtcars`**の**`disp`**データと**`hp`**データを用いてその違いを示します。  
　  

## dispデータ
### **`hist`**関数の場合
```{r, message=FALSE, echo=FALSE}
hist(mtcars$disp)
```

　  

### **`ggplot2::geom_histgram`**関数の場合
```{r, message=FALSE, echo=FALSE}
mtcars %>% 
  ggplot2::ggplot(aes(x = disp)) +
    geom_histogram()
```

　  

## hpデータ
### **`hist`**関数の場合
```{r, message=FALSE, echo=FALSE}
hist(mtcars$hp)
```

　  

### **`ggplot2::geom_histgram`**関数の場合
```{r, message=FALSE, echo=FALSE}
mtcars %>% 
  ggplot2::ggplot(aes(x = hp)) +
    geom_histogram()
```

　  

このようにデフォルト設定で描く両者のヒストグラムは似ても似つかぬ形状になることがあります。主な原因は**`hist`**関数は階級幅をSturgesの公式を用いて計算しているのに対して**`ggplot2::geom_histgram`**関数は単に30分割しているためです。  
　  
分布形状に影響を与えるオプションは下表のようになっていますので、階級幅の指定にSturgesの公式を用いれば、**`hist`**関数と**`ggplot2::gemo_histgram`**関数は同じ形状になることが分かります。

項目           | **`hist`**    | **`ggplot2::geom_histgram`**
---------------|---------------|------------
階級幅         | Sturgesの公式 | 単純30分割
階級の閉じ     | 右閉じ(, ]    | 右閉じ (, ]
階級下限境界値 | 含む          | 含む


```{r}
hist(mtcars$hp)
mtcars %>% 
  ggplot2::ggplot(aes(x = hp)) +
    geom_histogram(breaks = pretty(mtcars$hp,
                                   n = nclass.Sturges(mtcars$hp)))
```

　  

このように**`ggplot2::geom_histgram`**関数を利用する場合には階級幅の指定がポイントになります。  
　  

# 度数分布表
前述のようにヒストグラムを描くには度数分布表の作成、すなわち階級幅の指定方法が肝になります。  
　  

## 基本的な考え方
### 階級数
階級幅は階級数を元に決めますが、階級数の求め方にはさまざまな方法があります。代表的な計算方法としては以下のものがあげられます。  
　  

階級数の計算方法        | Rでの関数         | 備考
------------------------|-------------------|-----------
Square-root choice      | sqrt(length(x))   | データ数(n)の平方根
Sturges's formula       | nclass.Sturges(x) | データ数(n)が$n \ge 30$を満たす場合
Scott's choice          | nclass.scott(x)   | 標準偏差を用いる計算方法
Freedman-Diacnis choice | nclass.FD(x)      | 四分位範囲に基づく計算方法

　  

```{r, include=FALSE}
disp <- mtcars$disp
hp <- mtcars$hp
```

実際に**`mtcars`**データセットの**`disp`**と**`hp`**で階級数を求めてみます。  
　  

階級数の計算方法        | mtcars\$disp                  | mtcars$hp
------------------------|-------------------------------|-----------
Square-root choice      | `r round(sqrt(length(disp)))` | `r round(sqrt(length(hp)))`
Sturges's formula       | `r nclass.Sturges(disp)`      | `r nclass.Sturges(hp)`
Scott's choice          | `r nclass.scott(disp)`        | `r nclass.scott(hp)`
Freedman-Diacnis choice | `r nclass.FD(disp)`           | `r nclass.FD(hp)`

　  

### 階級幅
ヒストグラムを描画する際に必要となる適切な階級幅は得られた階級数をから**`pretty()`**関数で算出する必要があります。  
　  

```{r, eval=FALSE}
pretty(x, n)
```

  

**`pretty`**関数は$x$の値の範囲をカバーし$階級数+1$個となる（調整あり）ような階級幅を計算します。実際に**`pretty`**関数を用いて**`mtcars`**データセットの**`disp`**データと**`hp`**データに対する階級幅を計算してみると以下のようになります。  
　  

階級数の計算方法        | 階級数                        | 階級幅
------------------------|-------------------------------|-----------
Square-root choice      | `r round(sqrt(length(disp)))` | `r pretty(disp, round(sqrt(length(disp))))`
Sturges's formula       | `r nclass.Sturges(disp)`      | `r pretty(disp, nclass.Sturges(disp))`
Scott's choice          | `r nclass.scott(disp)`        | `r pretty(disp, nclass.scott(disp))`
Freedman-Diacnis choice | `r nclass.FD(disp)`           | `r pretty(disp, nclass.FD(disp))`

　  

階級数の計算方法        | 階級数                      | 階級幅
------------------------|-----------------------------|-----------
Square-root choice      | `r round(sqrt(length(hp)))` | `r pretty(hp, round(sqrt(length(hp))))`
Sturges's formula       | `r nclass.Sturges(hp)`      | `r pretty(hp, nclass.Sturges(hp))`
Scott's choice          | `r nclass.scott(hp)`        | `r pretty(hp, nclass.scott(hp))`
Freedman-Diacnis choice | `r nclass.FD(hp)`           | `r pretty(hp, nclass.FD(hp))`

　  

# ヒストグラム
```{r}
x <- mtcars$disp
```

## dispデータの場合
```{r}
x <- mtcars$disp

n <- round(sqrt(length(x)))
gg_src <- as.data.frame(x) %>% 
  ggplot2::ggplot(aes(x = x)) +
    ggplot2::geom_histogram(breaks = pretty(x, n)) +
    ggplot2::labs(title = "Square-root choice", x = "", y = "")

n <- nclass.Sturges(x)
gg_sf <- as.data.frame(x) %>% 
  ggplot2::ggplot(aes(x = x)) +
    ggplot2::geom_histogram(breaks = pretty(x, n)) +
    ggplot2::labs(title = "Sturges’s formula", x = "", y = "")

n <- nclass.scott(x)
gg_sc <- as.data.frame(x) %>% 
  ggplot2::ggplot(aes(x = x)) +
    ggplot2::geom_histogram(breaks = pretty(x, n)) +
    ggplot2::labs(title = "Scott’s choice", x = "", y = "")

n <- nclass.FD(x)
gg_fdc <- as.data.frame(x) %>% 
  ggplot2::ggplot(aes(x = x)) +
    ggplot2::geom_histogram(breaks = pretty(x, n)) +
    ggplot2::labs(title = "Freedman-Diacnis choice", x = "", y = "")

gridExtra::grid.arrange(gg_src, gg_sf, gg_sc, gg_fdc)
```

　  

## hpデータの場合
```{r}
x <- mtcars$hp

n <- round(sqrt(length(x)))
gg_src <- as.data.frame(x) %>% 
  ggplot2::ggplot(aes(x = x)) +
    ggplot2::geom_histogram(breaks = pretty(x, n)) +
    ggplot2::labs(title = "Square-root choice", x = "", y = "")

n <- nclass.Sturges(x)
gg_sf <- as.data.frame(x) %>% 
  ggplot2::ggplot(aes(x = x)) +
    ggplot2::geom_histogram(breaks = pretty(x, n)) +
    ggplot2::labs(title = "Sturges’s formula", x = "", y = "")

n <- nclass.scott(x)
gg_sc <- as.data.frame(x) %>% 
  ggplot2::ggplot(aes(x = x)) +
    ggplot2::geom_histogram(breaks = pretty(x, n)) +
    ggplot2::labs(title = "Scott’s choice", x = "", y = "")

n <- nclass.FD(x)
gg_fdc <- as.data.frame(x) %>% 
  ggplot2::ggplot(aes(x = x)) +
    ggplot2::geom_histogram(breaks = pretty(x, n)) +
    ggplot2::labs(title = "Freedman-Diacnis choice", x = "", y = "")

gridExtra::grid.arrange(gg_src, gg_sf, gg_sc, gg_fdc)
```

　  

# iris
```{r}
x <- iris$Sepal.Length
```


階級数の計算方法        | 階級数                        | 階級幅
------------------------|-------------------------------|-----------
Square-root choice      | `r round(sqrt(length(x)))` | `r pretty(x, round(sqrt(length(x))))`
Sturges's formula       | `r nclass.Sturges(x)`      | `r pretty(x, nclass.Sturges(x))`
Scott's choice          | `r nclass.scott(x)`        | `r pretty(x, nclass.scott(x))`
Freedman-Diacnis choice | `r nclass.FD(x)`           | `r pretty(x, nclass.FD(x))`

　  

```{r}
x <- iris$Sepal.Width
```


階級数の計算方法        | 階級数                        | 階級幅
------------------------|-------------------------------|-----------
Square-root choice      | `r round(sqrt(length(x)))` | `r pretty(x, round(sqrt(length(x))))`
Sturges's formula       | `r nclass.Sturges(x)`      | `r pretty(x, nclass.Sturges(x))`
Scott's choice          | `r nclass.scott(x)`        | `r pretty(x, nclass.scott(x))`
Freedman-Diacnis choice | `r nclass.FD(x)`           | `r pretty(x, nclass.FD(x))`

　  

```{r}
x <- iris$Petal.Length
```


階級数の計算方法        | 階級数                        | 階級幅
------------------------|-------------------------------|-----------
Square-root choice      | `r round(sqrt(length(x)))` | `r pretty(x, round(sqrt(length(x))))`
Sturges's formula       | `r nclass.Sturges(x)`      | `r pretty(x, nclass.Sturges(x))`
Scott's choice          | `r nclass.scott(x)`        | `r pretty(x, nclass.scott(x))`
Freedman-Diacnis choice | `r nclass.FD(x)`           | `r pretty(x, nclass.FD(x))`

　  

```{r}
x <- iris$Petal.Width
```


階級数の計算方法        | 階級数                        | 階級幅
------------------------|-------------------------------|-----------
Square-root choice      | `r round(sqrt(length(x)))` | `r pretty(x, round(sqrt(length(x))))`
Sturges's formula       | `r nclass.Sturges(x)`      | `r pretty(x, nclass.Sturges(x))`
Scott's choice          | `r nclass.scott(x)`        | `r pretty(x, nclass.scott(x))`
Freedman-Diacnis choice | `r nclass.FD(x)`           | `r pretty(x, nclass.FD(x))`

　  

```{r}
x <- iris$Petal.Length

n <- round(sqrt(length(x)))
gg_src <- as.data.frame(x) %>% 
  ggplot2::ggplot(aes(x = x)) +
    ggplot2::geom_histogram(breaks = pretty(x, n)) +
    ggplot2::labs(title = "Square-root choice", x = "", y = "")

n <- nclass.Sturges(x)
gg_sf <- as.data.frame(x) %>% 
  ggplot2::ggplot(aes(x = x)) +
    ggplot2::geom_histogram(breaks = pretty(x, n)) +
    ggplot2::labs(title = "Sturges’s formula", x = "", y = "")

n <- nclass.scott(x)
gg_sc <- as.data.frame(x) %>% 
  ggplot2::ggplot(aes(x = x)) +
    ggplot2::geom_histogram(breaks = pretty(x, n)) +
    ggplot2::labs(title = "Scott’s choice", x = "", y = "")

n <- nclass.FD(x)
gg_fdc <- as.data.frame(x) %>% 
  ggplot2::ggplot(aes(x = x)) +
    ggplot2::geom_histogram(breaks = pretty(x, n)) +
    ggplot2::labs(title = "Freedman-Diacnis choice", x = "", y = "")

gridExtra::grid.arrange(gg_src, gg_sf, gg_sc, gg_fdc)
```



---

```{r, child="../shared/footer.Rmd"}

```