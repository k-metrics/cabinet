---
title: "度数分布表を作る"
output:
  html_document:
    code_folding: none
    css: style.css
---

<!-- shared Links -->
```{r index, child="../shared/links.Rmd", include=FALSE}
```

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(tidyverse)
```

[R][R]で度数分布表を作るにはヒストグラムを描く関数**`graphics::hist()`**の返り値である**`counts`**と**`breaks`**を使う方法がありますが**`breaks`**から階級を起こすのが面倒です。そこで**`dplyr`**パッケージを用いて比較的簡単に度数分布表を作成する方法があります。  
　  

# 必要なパッケージ
本ページのコードを実行するには標準パッケージ以外に以下の追加パッケージを読み込んでおく必要があります。  
　  

Package   | Description
----------|-----------
tidyverse | Easily Install and Load the ‘Tidyverse’

　  

# 階級幅を決める
階級は描きたいヒストグラムに応じて任意に決めることができますが、階級の決め方で困った場合には公式などを用いて対象となるデータを元に階級数を求め、階級数から階級を決めることができます。  
　  

## 階級数の求め方
階級数を決めるのに比較的広く使われているのがスタージェスの公式です。スタージェスの公式はデータ数が多い場合やデータ分布が偏っている場合には不向きと言われており、このような場合にはスコットの選択やフリードマン・ダイアコニスの選択（FD法）を用いてみて下さい。これらの公式などは全て[R][R]の標準パッケージに関数として用意されています。  
　  

階級数の計算方法        | Rでの関数            | 備考
------------------------|----------------------|--------------------
Square-root choice      | **`sqrt`**           | 最もシンプルな方法
Sturges's formula       | **`nclass.Sturges`** | 最も一般的な方法
Scott's choice          | **`nclass.scott`**   |  
Freedman-Diacnis choice | **`nclass.FD`**      | 

　  
実際に**`iris`**データセットの**`Sepal.Length`**と**`Petal.Length`**のデータを用いて各計算方法で階級数がどのような値になるか比べてみます。  

　  

```{r, include=FALSE}
x <- iris$Sepal.Length
s_src <- round(sqrt(length(x)))
s_sf <- nclass.Sturges(x)
s_sc <- nclass.scott(x)
s_fdc <-nclass.FD(x)

x <- iris$Petal.Length
p_src <- round(sqrt(length(x)))
p_sf <- nclass.Sturges(x)
p_sc <- nclass.scott(x)
p_fdc <-nclass.FD(x)

```
階級数の計算方法        | 計算結果（Sepal.Length） | 計算結果（Petal.Length）
------------------------|--------------------------|-------------------------
Square-root choice      | `r s_src`                | `r p_src`
Sturges's formula       | `r s_sf`                 | `r p_sf`
Scott's choice          | `r s_sc`                 | `r p_sc`
Freedman-Diacnis choice | `r s_fdc`                | `r p_fdc`

　  
表からも分かるように平方根選択とスタージェスの公式はデータ数を元に階級数を決めています。一方、スコットの選択とフリードマン・ダイアコニスの選択はデータ数以外の要約統計量も用いて階級数を決めています。  
　  

## 階級幅の求め方
次に階級数に基づいて適切な階級幅を決めます。対象となるデータの範囲をカバーし等間隔の階級幅を求めるには**`pretty()`**関数が便利です。  
　  

```{r, include=FALSE}
x <- iris$Sepal.Length
range <- range(x)
s_src <- pretty(range, n = round(sqrt(length(x))))
s_sf <- pretty(range, n = nclass.Sturges(x))
s_sc <- pretty(range, n = nclass.scott(x))
s_fdc <- pretty(range, n = nclass.FD(x))

x <- iris$Petal.Length
range <- range(x)
p_src <- pretty(range, n = round(sqrt(length(x))))
p_sf <- pretty(range, n = nclass.Sturges(x))
p_sc <- pretty(range, n = nclass.scott(x))
p_fdc <- pretty(range, n = nclass.FD(x))
```
階級数の計算方法        | 階級（Sepal.Length）   | 階級（Petal.Length）
------------------------|------------------------|-------------------------
Square-root choice      | `r s_src`              | `r p_src`
Sturges's formula       | `r s_sf`               | `r p_sf`
Scott's choice          | `r s_sc`               | `r p_sc`
Freedman-Diacnis choice | `r s_fdc`              | `r p_fdc`

　  
このように階級数が異なっていても**`pretty`**関数で求めた階級（幅）は同一になることも
あります。  
　  

# 度数を求める
階級（幅）が求められたら個々の階級に入るデータの個数、すなわち度数を求めます。これには**`cut`**という関数を用いてデータを階級毎に分類してから度数をカウントするのが簡単です。この時、注意するのは階級の境界に当たるデータをどのように扱うかです。  
　  

境界条件 | 判定式              | 表現式       | 備考
---------|---------------------|--------------|------
右閉じ   | $lwr \lt x \le upr$ | $(lwr, upr]$ |
左閉じ   | $lwr \le x \lt upr$ | $[lwr, upr)$ | 
両閉じ   | $lwr \le x \le upr$ | $[lwr, upr]$ | 最下限のみ（指定による）

　  
なお、右閉じとした場合、データの最小値が最下限階級の境界にあたる場合、度数カウントに含むか含まないかを指定することができます。度数カウントに含む場合は最下限の階級は両閉じとなります。  

では、実際に先程の**`iris`**データセットを用いて度数分布表を作成してみます。  
　  

```{r}
iris %>% 
  dplyr::mutate(bin_w = cut(Sepal.Length,
                            pretty(range(Sepal.Length),
                                   n = nclass.Sturges(Sepal.Length)),
                            right = TRUE, include.lowest = TRUE)) %>% 
  dplyr::select(bin_w, Sepal.Length) %>% 
  dplyr::count(bin_w) %>% 
  dplyr::rename('階級' = bin_w, '度数' = n)
```

　  
以上で度数分布表の出来上がりです。  
　  

# 参考資料
* 


---

<!-- Footer -->
```{r child="../shared/footer.Rmd"}
```
