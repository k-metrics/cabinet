---
title: "ラベルが重ならないように描画する"
output:
  html_document:
    code_folding: none
    css: style.css
---

<!-- shared Links -->
```{r index, child="../shared/links.Rmd", include=FALSE}
```

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
require(tidyverse)
require(ggrepel)
```

**`ggplot2::text`**関数や**`ggplot2::label`**関数はデフォルトでデータの位置にラベルテキストを表示します。そのためデータの数が多い場合や、データの位置集まっているような場合にはラベルテキストが下図のように重なってしまい、読み取ることができません。  
　  

```{r, echo=FALSE}
mtcars %>% 
  ggplot2::ggplot(ggplot2::aes(x = wt, y = mpg, colour = as.factor(cyl))) + 
    ggplot2::geom_point(size = 3) + 
    ggplot2::geom_text(ggplot2::aes(label = rownames(.))) +
    ggplot2::labs(x = "重量[klbs]", y = "燃費[mpg]", colour = "気筒数")
```

　  
そこで、このような状態を解決するのに利用したいのがデータの位置に応じてラベルテキストを自動的に配置してくれる**`ggrepel`**パッケージです。  
　  

# 必要なパッケージ
本ページのコードを実行するには標準パッケージ以外に以下の追加パッケージを読み込んでおく必要があります。  
　  

Package   | Description
----------|-----------
ggrepel   | Repulsive Text and Label Geoms for 'ggplot2'
tidyverse | Easily Install and Load the ‘Tidyverse’

　  

# 描画例
　  

## **`ggrepel::geom_text_repel`**
テキスト（ラベル）を表示するには**`ggrepel::geom_text_repel`**関数を用います。基本的なパラメータ指定は**`ggplot2::geom_text`**と同じですので既存のコードを簡単に置き換えることが可能です。  
　  

```{r}
mtcars %>% 
  ggplot2::ggplot(ggplot2::aes(x = wt, y = mpg, colour = as.factor(cyl))) + 
    ggplot2::geom_point(size = 3) + 
    ggrepel::geom_text_repel(ggplot2::aes(label = rownames(.))) +
    ggplot2::labs(x = "重量[klbs]", y = "燃費[mpg]", colour = "気筒数")
```

　  

## **`ggrepel::geom_label_repel`**
ラベル（背景枠のついたテキスト）を表示する場合は**`ggrepel::geom_label_repel`**関数を用います。こちらも**`ggrepel::geom_text_repel`**関数と同様で**`ggplot2::geom_label`**関数と基本的なパラメータに互換性がありますので同様に使うことが可能です。  
　  

```{r}
mtcars %>% 
  ggplot2::ggplot(ggplot2::aes(x = wt, y = mpg, colour = as.factor(cyl))) + 
    ggplot2::geom_point(size = 3) +
    ggrepel::geom_label_repel(ggplot2::aes(label = rownames(.))) +
    ggplot2::labs(x = "重量[klbs]", y = "燃費[mpg]", colour = "気筒数")
```

　  

# 条件付き描画
外れ値などある条件を満たしたデータのみラベルテキストを表示したい場合が多々あります。このような場合は**`dplyr`**パッケージにある**`dplyr::case_when`**関数を用いてラベル側を加工しておくことで描画が可能になります。  
例えば、**`mtcars`**データセットにおいてマニュアル車のみラベルを表示する場合は以下のように指定することで条件を満たしたデータのみにラベルを表示することが可能になります。  
　  

```{r}
mtcars %>% 
  tibble::rownames_to_column("name") %>% 
  dplyr::mutate(label_text = dplyr::case_when(am == 1 ~ name, TRUE ~ "")) %>% 
  ggplot2::ggplot(ggplot2::aes(x = wt, y = mpg, colour = as.factor(cyl))) + 
    ggplot2::geom_point(size = 3) + 
    ggrepel::geom_label_repel(ggplot2::aes(label = label_text)) +
    ggplot2::labs(x = "重量[klbs]", y = "燃費[mpg]", colour = "気筒数")

```

　  

# 参考資料
* [Package Vignettes <i class="fa fa-external-link"></i>](https://cran.r-project.org/web/packages/ggrepel/vignettes/ggrepel.html){target="_blank" title="ggreple Usage Example"}
* [ggplot2 パッケージによる可視化の際のラベルの重なりを防ぐ <i class="fa fa-external-link"></i>](http://id.fnshr.info/2017/03/19/ggrepel/){target="_blank" title="Colorless Green Ideas"}
* [geom_pointへのテキストやラベルの付与に便利な「ggrepel」パッケージ <i class="fa fa-external-link"></i>](https://www.karada-good.net/analyticsr/r-377){target="_blank" title="からだにいいもの"}
* [dplyrのベクトル要素変換用関数3種 <i class="fa fa-external-link"></i>](https://suryu.me/post/dplyr_recode/){target="_blank" title="Sincere Pumpkin Patch"}
* [列の変換 - mutate関数 <i class="fa fa-external-link"></i>](https://kazutan.github.io/kazutanR/hands_on_170730/mutate.html){target="_blank" title="Kazutan.R"}
* [dplyrのVectorized Functionsについて <i class="fa fa-external-link"></i>](https://qiita.com/kazutan/items/083605af5f0c4da30b48){target="_blank" title="Qiita"}

　  

---

<!-- Footer -->
```{r child="../shared/footer.Rmd"}
```