---
title: "欠損を可視化する"
output:
  html_document:
    df_print: paged
    code_folding: none
    css: style.css
---

<!-- shared Links -->
```{r index, child="../shared/links.Rmd", include=FALSE}
```

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
require(mice)
require(VIM)
require(tidyverse)
```

データの欠損はその発生メカニズムにより対処方法が異なってきます。そこで、欠損に対して何等かの処理を行う場合には分析と同様に欠損を可視化することにより欠損のパターンを把握しておくことが大切です。  
本ページでは欠損を可視化するのに有用な方法を紹介します。  
　  
なお、本ページでは`r R.version$version.string`の標準パッケージ以外に以下の追加パッケージを用いています。  
　  

Package   | Version |Description
----------|---------|----------------------------------------------------------
tidyverse | `r packageVersion('tidyverse')` | Easily Install and Load the ‘Tidyverse’
mice      | `r packageVersion('mice')` |Multivariate Imputation by Chained Equations
VIM       | `r packageVersion('VIM')` | Visualization and Imputation of Missing Values 
skimr     | `r packageVersion('skimr')` | Compact and Flexible Summaries of Data

　  

また、本ページでは以下のデータセットを用いています。  
　  

Dataset    | Package  | Version | Description
-----------|----------|---------|----------------------------------------------
airquality | datasets | `r packageVersion('datasets')`| New York Air Quality Measurements

　  

`airquarity`データセットはNYの大気観測データですが、下記のサマライズのように`Ozone`と`Solar.R`に欠損値を持っています。  
　  

```{r, echo=FALSE}
skimr::skim_to_wide(airquality)
```

　  

# 欠損の分布を可視化する
データ内のどの位置に欠損があるかを確認するには`VIM`パッケージを用いるのが便利です。  
　  

## 箱ひげ図による可視化
箱ひげ図を用いた可視化には`VIM::pbox`関数を使います。データフレームの最初にある変数を縦軸に縦軸に配置します（今ひとつ変数の指定方法が分からないので分かりましたら追記します）。  
　  

```{r}
airquality %>% 
  # dplyr::select(-Month, -Day) %>%
  tibble::rowid_to_column("days") %>%
  VIM::pbox()
```

　  

## ヒートマップによる可視化
ヒートマップを用いた可視化には`VIM::matrixplot`関数を使います。欠損の位置をヒートマップ上にプロットしてくれます。ヒートマップですので各変数の値の変化も把握できます。縦軸は表示の通りインデックスで、赤色の部分が欠損です。グレーの部分は値がある部分で、色の濃さにより数値の大小を表しています。  
　  

```{r}
airquality %>% 
  dplyr::select(-Month, -Day) %>% 
  VIM::matrixplot()
```

　  

# 欠損の組み合わせを可視化する
データ内の特定の組み合わせで欠損が発生しているか否かを可視化するには`mice::md.pattern`関数または`VIM::aggr`関数が便利です。  
　  

## マトリクス（タイル）による可視化
`mice::md.pattern`関数はテキスト表とタイルグラフの二種類の出力してくれます。グラフの出力を抑制したい場合には`plot = FALSE`オプションを指定してください。  
　  
グラフ出力では欠損がある部分をマゼンタ、欠損がない部分をシアンで表示し、どのような組み合わせで欠損が発生しているかを視覚的に把握することができます。  
　  

```{r}
airquality %>%
  mice::md.pattern()
```

　  
テキスト表の場合は「0:欠損あり、1:欠損なし」という表示になっていますので注意してください。  
　  
　  
## タイルとヒストグラムによる可視化
`VIM::aggr`関数は前述の`mice::md.pattern`関数と同様の可視化に加えて欠損数も可視化してくれるの関数です。ただし、`mice::md.pattern`関数とは逆の表示になっているので注意してください。また、デフォルトパラメータで使うよりも以下のオプションを指定した方が傾向を把握しやすいと思います。  
　  

```{r}
airquality %>%
  VIM::aggr(prop = FALSE, number = TRUE)
```

　  
# 欠損の関連性を可視化する
欠損の発生が他の変数と関連がありそうな場合、他の変数が取る値と欠損の関係性を確認するための可視化には`VIM`パッケージが便利です。  
　  

## ヒストグラムによる可視化
ヒストグラムを用いた可視化には`VIM::barMiss`関数を使います。`VIM::barMiss`関数は縦軸に欠損を含む変数の度数、横軸に関係性を確認したい変数を配置することで、関係性を確認したい変数の特定の値で欠損が発生しているか否かを把握できるようにしています。  
データフレームにある最初の変数を横軸、二番目の変数を縦軸に配置しますので`dplyr::select`関数と組み合わせて明示的に変数を指定した方が分かりやすいと思います。  
　  

```{r}
airquality %>% 
  VIM::barMiss(only.miss = FALSE, main = "データフレームを指定した場合")

airquality %>% 
  dplyr::select(Ozone, Solar.R) %>% 
  VIM::barMiss(only.miss = FALSE, main = "OzoneとSolar.Rだけを明示的に指定した場合")

airquality %>% 
  dplyr::select(Wind, Ozone) %>% 
  VIM::barMiss(only.miss = FALSE)
```


## 散布図行列による可視化
散布図行列を用いた可視化には`VIM::scattmatrixMiss`関数を使います。散布図に使われている当該変数を除いた変数に欠損がある場合は赤色の印で表示します。これにより欠損が他の変数の影響を受けているか否かを確認することができます。  
　  

```{r}
airquality %>% 
  dplyr::select(-Month, -Day) %>% 
  VIM::scattmatrixMiss()
```

　  

## 散布図による可視化
散布図を用いた可視化には`VIM::marginplot`関数を用います。散布図ですので**二変数間**における欠損の関係を把握する場合に使います。欠損が変数の特定の値に集中しているかどうかが一目で分かります。  
　  

```{r}
airquality %>% 
  dplyr::select(Ozone, Solar.R) %>%
  VIM::marginplot()
```

　  

# 参考資料

* [R 欠損値の対応（missing value treatment） <i class="fa fa-external-link"></i>](http://jojoshin.hatenablog.com/entry/2017/02/03/220118){target="_blank" title="統計学と疫学と時々、助教生活"}
* [Rで解析：欠損値を制するモノは解析も制す？「VIM」パッケージの紹介 <i class="fa fa-external-link"></i>](https://www.karada-good.net/analyticsr/r-147){target="_blank" title="からだにいいもの"}
* [欠損値があるデータの分析 <i class="fa fa-external-link"></i>](http://norimune.net/1811){target="_blank" title="Sunny side up!"}

　  

---

<!-- Footer -->
```{r child="../shared/footer.Rmd"}
```